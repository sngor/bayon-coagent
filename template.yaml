AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Bayon CoAgent - Serverless Infrastructure

Parameters:
  Environment:
    Type: String
    Default: development
    AllowedValues:
      - development
      - production
    Description: Environment name

  AlarmEmail:
    Type: String
    Default: ""
    Description: Email address for CloudWatch alarms (optional)

Conditions:
  IsProduction: !Equals [!Ref Environment, production]
  HasAlarmEmail: !Not [!Equals [!Ref AlarmEmail, ""]]

Globals:
  Function:
    Timeout: 30
    MemorySize: 1024
    Runtime: nodejs22.x
    Tracing: Active
    Environment:
      Variables:
        NODE_ENV: !Ref Environment
        COGNITO_USER_POOL_ID: !Ref UserPool
        COGNITO_CLIENT_ID: !Ref UserPoolClient
        DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
        S3_BUCKET_NAME: !Ref StorageBucket
        BEDROCK_MODEL_ID: anthropic.claude-3-5-sonnet-20241022-v2:0
        BEDROCK_REGION: !Ref AWS::Region
        XRAY_TRACING_ENABLED: true
        XRAY_SERVICE_NAME: !Sub bayon-coagent-${Environment}
        EVENT_BUS_NAME: !Ref ApplicationEventBus

Resources:
  # ==========================================
  # Cognito User Pool
  # ==========================================
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub bayon-coagent-${Environment}
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Schema:
        - Name: email
          Required: true
          Mutable: true
        - Name: given_name
          Required: false
          Mutable: true
        - Name: family_name
          Required: false
          Mutable: true
        - Name: agentId
          AttributeDataType: String
          Mutable: true
        - Name: businessName
          AttributeDataType: String
          Mutable: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireUppercase: true
          RequireNumbers: true
          RequireSymbols: true
          TemporaryPasswordValidityDays: 7
      MfaConfiguration: "OFF"
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      UserAttributeUpdateSettings:
        AttributesRequireVerificationBeforeUpdate:
          - email
      EmailConfiguration:
        EmailSendingAccount: COGNITO_DEFAULT
      UserPoolTags:
        Environment: !Ref Environment
        Application: BayonCoAgent

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub bayon-coagent-web-${Environment}
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_CUSTOM_AUTH
      PreventUserExistenceErrors: ENABLED
      RefreshTokenValidity: 30
      AccessTokenValidity: 60
      IdTokenValidity: 60
      TokenValidityUnits:
        RefreshToken: days
        AccessToken: minutes
        IdToken: minutes
      EnableTokenRevocation: true
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      AllowedOAuthFlowsUserPoolClient: true
      CallbackURLs:
        - !If
          - IsProduction
          - https://yourdomain.com/oauth/callback
          - http://localhost:3000/oauth/callback
      LogoutURLs:
        - !If
          - IsProduction
          - https://yourdomain.com
          - http://localhost:3000

  IdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !Sub bayon_coagent_${Environment}
      AllowUnauthenticatedIdentities: false
      CognitoIdentityProviders:
        - ClientId: !Ref UserPoolClient
          ProviderName: !GetAtt UserPool.ProviderName

  IdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref IdentityPool
      Roles:
        authenticated: !GetAtt AuthenticatedRole.Arn

  AuthenticatedRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                cognito-identity.amazonaws.com:aud: !Ref IdentityPool
              ForAnyValue:StringLike:
                cognito-identity.amazonaws.com:amr: authenticated
      Policies:
        - PolicyName: UserScopedAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                Resource: !GetAtt DynamoDBTable.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub ${StorageBucket.Arn}/*
              - Effect: Allow
                Action: s3:ListBucket
                Resource: !GetAtt StorageBucket.Arn

  # ==========================================
  # DynamoDB Table
  # ==========================================
  # GSI Index Usage:
  # - GSI1: General purpose index (existing)
  # - GSI2: Content workflow scheduling - SCHEDULE#<status> → TIME#<publishTime>
  #   Purpose: Query all scheduled content by status and time for background job processing
  #   Example: Query all "scheduled" content due for publishing
  # - GSI3: Content workflow analytics - ANALYTICS#<contentType> → DATE#<publishDate>
  #   Purpose: Aggregate analytics by content type for performance comparisons
  #   Example: Get all "blog_post" analytics for time-based analysis
  # - GSI4: Template discovery - TEMPLATE#<contentType> → NAME#<name>
  #   Purpose: Browse and search templates by type
  #   Example: Find all "social_media" templates sorted by name
  # - EntityTypeIndex: Entity type queries (existing)
  # - UserIndex: User-based queries (existing)
  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub BayonCoAgent-${Environment}
      BillingMode: PAY_PER_REQUEST
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If [IsProduction, true, false]
      SSESpecification:
        SSEEnabled: true
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: GSI2PK
          AttributeType: S
        - AttributeName: GSI2SK
          AttributeType: S
        - AttributeName: GSI3PK
          AttributeType: S
        - AttributeName: GSI3SK
          AttributeType: S
        - AttributeName: GSI4PK
          AttributeType: S
        - AttributeName: GSI4SK
          AttributeType: S
        - AttributeName: EntityType
          AttributeType: S
        - AttributeName: CreatedAt
          AttributeType: N
        - AttributeName: UserId
          AttributeType: S
        - AttributeName: UpdatedAt
          AttributeType: N
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        # Content Workflow Scheduling Index - SCHEDULE#<status> → TIME#<publishTime>
        - IndexName: GSI2
          KeySchema:
            - AttributeName: GSI2PK
              KeyType: HASH
            - AttributeName: GSI2SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        # Content Workflow Analytics Index - ANALYTICS#<contentType> → DATE#<publishDate>
        - IndexName: GSI3
          KeySchema:
            - AttributeName: GSI3PK
              KeyType: HASH
            - AttributeName: GSI3SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        # Template Discovery Index - TEMPLATE#<contentType> → NAME#<name>
        - IndexName: GSI4
          KeySchema:
            - AttributeName: GSI4PK
              KeyType: HASH
            - AttributeName: GSI4SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: EntityTypeIndex
          KeySchema:
            - AttributeName: EntityType
              KeyType: HASH
            - AttributeName: CreatedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: UserIndex
          KeySchema:
            - AttributeName: UserId
              KeyType: HASH
            - AttributeName: UpdatedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent

  # ==========================================
  # S3 Storage Bucket
  # ==========================================
  StorageBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub bayon-coagent-storage-${Environment}-${AWS::AccountId}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: !If [IsProduction, Enabled, Suspended]
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 90
          - Id: TransitionToIA
            Status: !If [IsProduction, Enabled, Disabled]
            Transitions:
              - TransitionInDays: 90
                StorageClass: STANDARD_IA
          - Id: ArchiveOldReimagineEdits
            Status: !If [IsProduction, Enabled, Disabled]
            Prefix: reimagine/edits/
            Transitions:
              - TransitionInDays: 90
                StorageClass: STANDARD_IA
              - TransitionInDays: 180
                StorageClass: GLACIER
          - Id: DeleteReimaginePreviewEdits
            Status: Enabled
            Prefix: reimagine/preview/
            ExpirationInDays: 7
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins:
              - !If
                - IsProduction
                - https://yourdomain.com
                - http://localhost:3000
            AllowedMethods:
              - GET
              - PUT
              - POST
              - DELETE
              - HEAD
            AllowedHeaders:
              - "*"
            ExposedHeaders:
              - ETag
              - x-amz-server-side-encryption
              - x-amz-request-id
              - x-amz-id-2
              - Content-Type
              - Content-Length
            MaxAge: 3000
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent

  StorageBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref StorageBucket
      PolicyDocument:
        Statement:
          - Sid: AllowApplicationAccess
            Effect: Allow
            Principal:
              AWS: !GetAtt ApplicationRole.Arn
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:ListBucket
            Resource:
              - !GetAtt StorageBucket.Arn
              - !Sub ${StorageBucket.Arn}/*

  # ==========================================
  # IAM Roles
  # ==========================================
  ApplicationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub bayon-coagent-app-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
                - ecs-tasks.amazonaws.com
                - amplify.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: CognitoAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:AdminGetUser
                  - cognito-idp:AdminCreateUser
                  - cognito-idp:AdminUpdateUserAttributes
                  - cognito-idp:AdminDeleteUser
                  - cognito-idp:ListUsers
                Resource: !GetAtt UserPool.Arn
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                  - dynamodb:DescribeStream
                  - dynamodb:GetRecords
                  - dynamodb:GetShardIterator
                  - dynamodb:ListStreams
                Resource:
                  - !GetAtt DynamoDBTable.Arn
                  - !Sub ${DynamoDBTable.Arn}/index/*
                  - !Sub ${DynamoDBTable.Arn}/stream/*
        - PolicyName: S3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt StorageBucket.Arn
                  - !Sub ${StorageBucket.Arn}/*
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/bayon-coagent/*
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:ListFoundationModels
                  - bedrock:GetFoundationModel
                Resource:
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-*
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-image-generator-v1
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-*
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/stability.stable-diffusion-xl-v1
        - PolicyName: SecretsManagerAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Ref GoogleOAuthSecret
                  - !Ref FacebookOAuthSecret
                  - !Ref InstagramOAuthSecret
                  - !Ref LinkedInOAuthSecret
                  - !Ref TwitterOAuthSecret
                  - !Ref MLSAPISecret
        - PolicyName: EventBridgeAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - events:PutEvents
                Resource: !GetAtt ApplicationEventBus.Arn
        - PolicyName: ApiGatewayInvokeAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - execute-api:Invoke
                Resource:
                  - !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AiServiceApi}/*
                  - !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${IntegrationServiceApi}/*
                  - !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${BackgroundServiceApi}/*
                  - !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AdminServiceApi}/*
        - PolicyName: CodeDeployAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - codedeploy:PutLifecycleEventHookExecutionStatus
                Resource: "*"
        - PolicyName: CloudWatchMetricsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:GetMetricStatistics
                  - cloudwatch:DescribeAlarms
                Resource: "*"
        - PolicyName: LambdaInvokeAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: "*"

  # ==========================================
  # API Gateway for Service Boundaries
  # ==========================================

  # CloudWatch Log Group for API Gateway
  ApiGatewayLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/apigateway/bayon-coagent-${Environment}
      RetentionInDays: !If [IsProduction, 30, 7]

  # Main API Gateway for Core Platform Service
  MainRestApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub bayon-coagent-main-${Environment}
      Description: !Sub Bayon CoAgent Main API Gateway (${Environment})
      EndpointConfiguration:
        Types:
          - REGIONAL
      Policy:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal: "*"
            Action: execute-api:Invoke
            Resource: "*"

  # AI Processing Service API Gateway
  AiServiceApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub bayon-coagent-ai-${Environment}
      Description: !Sub Bayon CoAgent AI Processing Service API (${Environment})
      EndpointConfiguration:
        Types:
          - REGIONAL

  # External Integration Service API Gateway
  IntegrationServiceApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub bayon-coagent-integration-${Environment}
      Description: !Sub Bayon CoAgent Integration Service API (${Environment})
      EndpointConfiguration:
        Types:
          - REGIONAL

  # Background Processing Service API Gateway
  BackgroundServiceApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub bayon-coagent-background-${Environment}
      Description: !Sub Bayon CoAgent Background Processing Service API (${Environment})
      EndpointConfiguration:
        Types:
          - REGIONAL

  # Admin Service API Gateway
  AdminServiceApi:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub bayon-coagent-admin-${Environment}
      Description: !Sub Bayon CoAgent Admin Service API (${Environment})
      EndpointConfiguration:
        Types:
          - REGIONAL

  # API Gateway Deployments and Stages
  MainApiDeployment:
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId: !Ref MainRestApi
      Description: !Sub Main API deployment for ${Environment}

  MainApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref MainRestApi
      DeploymentId: !Ref MainApiDeployment
      StageName: v1
      Description: !Sub Main API v1 stage for ${Environment}
      TracingEnabled: true
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: INFO
          DataTraceEnabled: !If [IsProduction, false, true]
          MetricsEnabled: true
          ThrottlingRateLimit: !If [IsProduction, 1000, 100]
          ThrottlingBurstLimit: !If [IsProduction, 2000, 200]
      AccessLogSetting:
        DestinationArn: !GetAtt ApiGatewayLogGroup.Arn
        Format: >
          {
            "requestId": "$context.requestId",
            "ip": "$context.identity.sourceIp",
            "caller": "$context.identity.caller",
            "user": "$context.identity.user",
            "requestTime": "$context.requestTime",
            "httpMethod": "$context.httpMethod",
            "resourcePath": "$context.resourcePath",
            "status": "$context.status",
            "protocol": "$context.protocol",
            "responseLength": "$context.responseLength",
            "error.message": "$context.error.message",
            "error.messageString": "$context.error.messageString",
            "traceId": "$context.xrayTraceId",
            "apiVersion": "$context.stage"
          }

  # AI Service API Gateway Resources and Methods

  # /jobs resource
  AiServiceJobsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AiServiceApi
      ParentId: !GetAtt AiServiceApi.RootResourceId
      PathPart: jobs

  # POST /jobs - Submit AI job
  AiServiceSubmitJobMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AiServiceApi
      ResourceId: !Ref AiServiceJobsResource
      HttpMethod: POST
      AuthorizationType: AWS_IAM
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:sqs:path/${AWS::AccountId}/${AiJobRequestQueue.QueueName}
        Credentials: !GetAtt AiServiceApiGatewayRole.Arn
        RequestParameters:
          integration.request.header.Content-Type: "'application/x-www-form-urlencoded'"
        RequestTemplates:
          application/json: |
            Action=SendMessage&MessageBody=$util.urlEncode($input.body)
        IntegrationResponses:
          - StatusCode: 200
            ResponseTemplates:
              application/json: |
                {
                  "jobId": "$context.requestId",
                  "status": "submitted",
                  "message": "Job submitted successfully"
                }
      MethodResponses:
        - StatusCode: 200
          ResponseModels:
            application/json: !Ref SuccessResponseModel

  # /jobs/{jobId} resource
  AiServiceJobIdResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AiServiceApi
      ParentId: !Ref AiServiceJobsResource
      PathPart: "{jobId}"

  # GET /jobs/{jobId} - Get job status
  AiServiceGetJobMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AiServiceApi
      ResourceId: !Ref AiServiceJobIdResource
      HttpMethod: GET
      AuthorizationType: AWS_IAM
      RequestParameters:
        method.request.path.jobId: true
      Integration:
        Type: AWS
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:dynamodb:action/GetItem
        Credentials: !GetAtt AiServiceApiGatewayRole.Arn
        RequestTemplates:
          application/json: !Sub |
            {
              "TableName": "${DynamoDBTable}",
              "Key": {
                "PK": {"S": "USER#$context.authorizer.principalId"},
                "SK": {"S": "AIJOB#$input.params('jobId')"}
              }
            }
        IntegrationResponses:
          - StatusCode: 200
            ResponseTemplates:
              application/json: |
                #set($item = $input.path('$.Item'))
                {
                  "jobId": "$item.SK.S",
                  "status": "$item.Status.S",
                  "jobType": "$item.JobType.S",
                  "createdAt": "$item.CreatedAt.S",
                  "updatedAt": "$item.UpdatedAt.S"
                  #if($item.Result)
                  ,"result": $item.Result.S
                  #end
                  #if($item.Error)
                  ,"error": "$item.Error.S"
                  #end
                  #if($item.CompletedAt)
                  ,"completedAt": "$item.CompletedAt.S"
                  #end
                }
          - StatusCode: 404
            SelectionPattern: '.*"Item":null.*'
            ResponseTemplates:
              application/json: |
                {
                  "error": {
                    "code": "NOT_FOUND",
                    "message": "Job not found"
                  }
                }
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 404

  # IAM Role for AI Service API Gateway
  AiServiceApiGatewayRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub bayon-coagent-ai-service-api-gateway-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource: !GetAtt AiJobRequestQueue.Arn
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                Resource: !GetAtt DynamoDBTable.Arn

  AiServiceApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - AiServiceSubmitJobMethod
      - AiServiceGetJobMethod
      - AiServiceHealthMethod
    Properties:
      RestApiId: !Ref AiServiceApi
      Description: !Sub AI Service API deployment for ${Environment}

  AiServiceApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref AiServiceApi
      DeploymentId: !Ref AiServiceApiDeployment
      StageName: v1
      Description: !Sub AI Service API stage for ${Environment}
      TracingEnabled: true
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: INFO
          DataTraceEnabled: !If [IsProduction, false, true]
          MetricsEnabled: true
          ThrottlingRateLimit: !If [IsProduction, 1000, 100]
          ThrottlingBurstLimit: !If [IsProduction, 2000, 200]

  # Integration Service API Gateway Resources and Methods

  # /oauth resource
  IntegrationServiceOAuthResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !GetAtt IntegrationServiceApi.RootResourceId
      PathPart: oauth

  # /oauth/google resource
  IntegrationServiceGoogleResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !Ref IntegrationServiceOAuthResource
      PathPart: google

  # /oauth/google/authorize resource
  IntegrationServiceGoogleAuthorizeResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !Ref IntegrationServiceGoogleResource
      PathPart: authorize

  # GET /oauth/google/authorize
  IntegrationServiceGoogleAuthorizeMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ResourceId: !Ref IntegrationServiceGoogleAuthorizeResource
      HttpMethod: GET
      AuthorizationType: AWS_IAM
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IntegrationGoogleOAuthFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /oauth/google/callback resource
  IntegrationServiceGoogleCallbackResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !Ref IntegrationServiceGoogleResource
      PathPart: callback

  # GET /oauth/google/callback
  # Note: OAuth callbacks must remain NONE as they are called by external OAuth providers
  IntegrationServiceGoogleCallbackMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ResourceId: !Ref IntegrationServiceGoogleCallbackResource
      HttpMethod: GET
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IntegrationGoogleOAuthFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /oauth/{platform} resource for social media
  IntegrationServiceSocialPlatformResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !Ref IntegrationServiceOAuthResource
      PathPart: "{platform}"

  # /oauth/{platform}/authorize resource
  IntegrationServiceSocialAuthorizeResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !Ref IntegrationServiceSocialPlatformResource
      PathPart: authorize

  # GET /oauth/{platform}/authorize
  IntegrationServiceSocialAuthorizeMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ResourceId: !Ref IntegrationServiceSocialAuthorizeResource
      HttpMethod: GET
      AuthorizationType: AWS_IAM
      RequestParameters:
        method.request.path.platform: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IntegrationSocialOAuthFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /oauth/{platform}/callback resource
  IntegrationServiceSocialCallbackResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !Ref IntegrationServiceSocialPlatformResource
      PathPart: callback

  # GET /oauth/{platform}/callback
  # Note: OAuth callbacks must remain NONE as they are called by external OAuth providers
  IntegrationServiceSocialCallbackMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ResourceId: !Ref IntegrationServiceSocialCallbackResource
      HttpMethod: GET
      AuthorizationType: NONE
      RequestParameters:
        method.request.path.platform: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IntegrationSocialOAuthFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /mls resource
  IntegrationServiceMLSResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !GetAtt IntegrationServiceApi.RootResourceId
      PathPart: mls

  # /mls/sync resource
  IntegrationServiceMLSSyncResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !Ref IntegrationServiceMLSResource
      PathPart: sync

  # POST /mls/sync
  IntegrationServiceMLSSyncMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ResourceId: !Ref IntegrationServiceMLSSyncResource
      HttpMethod: POST
      AuthorizationType: AWS_IAM
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IntegrationMLSSyncFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /mls/status resource
  IntegrationServiceMLSStatusResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !Ref IntegrationServiceMLSResource
      PathPart: status

  # /mls/status/{syncId} resource
  IntegrationServiceMLSStatusIdResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !Ref IntegrationServiceMLSStatusResource
      PathPart: "{syncId}"

  # GET /mls/status/{syncId}
  IntegrationServiceMLSStatusMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ResourceId: !Ref IntegrationServiceMLSStatusIdResource
      HttpMethod: GET
      AuthorizationType: AWS_IAM
      RequestParameters:
        method.request.path.syncId: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IntegrationMLSSyncFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # Lambda Permissions for API Gateway to invoke Integration Service functions
  IntegrationGoogleOAuthLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref IntegrationGoogleOAuthFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${IntegrationServiceApi}/*

  IntegrationSocialOAuthLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref IntegrationSocialOAuthFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${IntegrationServiceApi}/*

  IntegrationMLSSyncLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref IntegrationMLSSyncFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${IntegrationServiceApi}/*

  IntegrationServiceApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - IntegrationServiceGoogleAuthorizeMethod
      - IntegrationServiceGoogleCallbackMethod
      - IntegrationServiceSocialAuthorizeMethod
      - IntegrationServiceSocialCallbackMethod
      - IntegrationServiceMLSSyncMethod
      - IntegrationServiceMLSStatusMethod
      - IntegrationServiceHealthMethod
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      Description: !Sub Integration Service API deployment for ${Environment}

  IntegrationServiceApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      DeploymentId: !Ref IntegrationServiceApiDeployment
      StageName: v1
      Description: !Sub Integration Service API stage for ${Environment}
      TracingEnabled: true
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: INFO
          DataTraceEnabled: !If [IsProduction, false, true]
          MetricsEnabled: true
          ThrottlingRateLimit: !If [IsProduction, 500, 50]
          ThrottlingBurstLimit: !If [IsProduction, 1000, 100]

  BackgroundServiceApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - BackgroundServiceHealthMethod
    Properties:
      RestApiId: !Ref BackgroundServiceApi
      Description: !Sub Background Service API deployment for ${Environment}

  BackgroundServiceApiStage:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref BackgroundServiceApi
      DeploymentId: !Ref BackgroundServiceApiDeployment
      StageName: v1
      Description: !Sub Background Service API stage for ${Environment}
      TracingEnabled: true
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: INFO
          DataTraceEnabled: !If [IsProduction, false, true]
          MetricsEnabled: true
          ThrottlingRateLimit: !If [IsProduction, 200, 20]
          ThrottlingBurstLimit: !If [IsProduction, 400, 40]

  # Admin Service API Deployment and Stage are defined later after all resources are created

  # ==========================================
  # Health Check Endpoints for All Services
  # ==========================================

  # AI Service Health Check
  AiServiceHealthResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AiServiceApi
      ParentId: !GetAtt AiServiceApi.RootResourceId
      PathPart: health

  AiServiceHealthMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AiServiceApi
      ResourceId: !Ref AiServiceHealthResource
      HttpMethod: GET
      AuthorizationType: AWS_IAM
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AiServiceHealthCheckFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 503

  AiServiceHealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-health-check-ai-service-${Environment}
      CodeUri: src/lambda/
      Handler: health-check-ai-service.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 256
      Role: !GetAtt AiProcessingLambdaRole.Arn
      Environment:
        Variables:
          AI_JOB_REQUEST_QUEUE_URL: !Ref AiJobRequestQueue
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AIProcessing
        Function: HealthCheck

  AiServiceHealthCheckPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AiServiceHealthCheckFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AiServiceApi}/*

  # Integration Service Health Check
  IntegrationServiceHealthResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ParentId: !GetAtt IntegrationServiceApi.RootResourceId
      PathPart: health

  IntegrationServiceHealthMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref IntegrationServiceApi
      ResourceId: !Ref IntegrationServiceHealthResource
      HttpMethod: GET
      AuthorizationType: AWS_IAM
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${IntegrationServiceHealthCheckFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 503

  IntegrationServiceHealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-health-check-integration-service-${Environment}
      CodeUri: src/lambda/
      Handler: health-check-integration-service.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 256
      Role: !GetAtt IntegrationServiceLambdaRole.Arn
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: IntegrationService
        Function: HealthCheck

  IntegrationServiceHealthCheckPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref IntegrationServiceHealthCheckFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${IntegrationServiceApi}/*

  # Background Service Health Check
  BackgroundServiceHealthResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref BackgroundServiceApi
      ParentId: !GetAtt BackgroundServiceApi.RootResourceId
      PathPart: health

  BackgroundServiceHealthMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref BackgroundServiceApi
      ResourceId: !Ref BackgroundServiceHealthResource
      HttpMethod: GET
      AuthorizationType: AWS_IAM
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${BackgroundServiceHealthCheckFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 503

  BackgroundServiceHealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-health-check-background-service-${Environment}
      CodeUri: src/lambda/
      Handler: health-check-background-service.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 256
      Role: !GetAtt ContentWorkflowLambdaRole.Arn
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: BackgroundService
        Function: HealthCheck

  BackgroundServiceHealthCheckPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref BackgroundServiceHealthCheckFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${BackgroundServiceApi}/*

  # Admin Service Health Check
  AdminServiceHealthResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !GetAtt AdminServiceApi.RootResourceId
      PathPart: health

  AdminServiceHealthMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceHealthResource
      HttpMethod: GET
      AuthorizationType: AWS_IAM
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminServiceHealthCheckFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200
        - StatusCode: 503

  AdminServiceHealthCheckFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-health-check-admin-service-${Environment}
      CodeUri: src/lambda/
      Handler: health-check-admin-service.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 256
      Role: !GetAtt ApplicationRole.Arn
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AdminService
        Function: HealthCheck

  AdminServiceHealthCheckPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AdminServiceHealthCheckFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AdminServiceApi}/*

  # ==========================================
  # Cognito JWT Token Authorizer
  # ==========================================

  # Cognito Authorizer Lambda Function
  CognitoAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-cognito-authorizer-${Environment}
      CodeUri: src/lambda/
      Handler: cognito-authorizer.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 256
      Role: !GetAtt CognitoAuthorizerRole.Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: CognitoAuthorizer

  # IAM Role for Cognito Authorizer
  CognitoAuthorizerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub bayon-coagent-cognito-authorizer-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CognitoAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:GetUser
                  - cognito-idp:DescribeUserPool
                Resource: !GetAtt UserPool.Arn
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/bayon-coagent-cognito-authorizer-${Environment}*

  # Lambda Permissions for API Gateways to invoke authorizer
  CognitoAuthorizerMainApiPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CognitoAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${MainRestApi}/authorizers/*

  CognitoAuthorizerAiServicePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CognitoAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AiServiceApi}/authorizers/*

  CognitoAuthorizerIntegrationServicePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CognitoAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${IntegrationServiceApi}/authorizers/*

  CognitoAuthorizerBackgroundServicePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CognitoAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${BackgroundServiceApi}/authorizers/*

  CognitoAuthorizerAdminServicePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CognitoAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AdminServiceApi}/authorizers/*

  # API Gateway Authorizers for each service
  MainApiCognitoAuthorizer:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      Name: !Sub bayon-coagent-main-cognito-authorizer-${Environment}
      Type: TOKEN
      AuthorizerUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CognitoAuthorizerFunction.Arn}/invocations
      AuthorizerCredentials: !GetAtt ApiGatewayAuthorizerRole.Arn
      AuthorizerResultTtlInSeconds: 300
      IdentitySource: method.request.header.Authorization
      RestApiId: !Ref MainRestApi

  AiServiceCognitoAuthorizer:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      Name: !Sub bayon-coagent-ai-cognito-authorizer-${Environment}
      Type: TOKEN
      AuthorizerUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CognitoAuthorizerFunction.Arn}/invocations
      AuthorizerCredentials: !GetAtt ApiGatewayAuthorizerRole.Arn
      AuthorizerResultTtlInSeconds: 300
      IdentitySource: method.request.header.Authorization
      RestApiId: !Ref AiServiceApi

  IntegrationServiceCognitoAuthorizer:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      Name: !Sub bayon-coagent-integration-cognito-authorizer-${Environment}
      Type: TOKEN
      AuthorizerUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CognitoAuthorizerFunction.Arn}/invocations
      AuthorizerCredentials: !GetAtt ApiGatewayAuthorizerRole.Arn
      AuthorizerResultTtlInSeconds: 300
      IdentitySource: method.request.header.Authorization
      RestApiId: !Ref IntegrationServiceApi

  BackgroundServiceCognitoAuthorizer:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      Name: !Sub bayon-coagent-background-cognito-authorizer-${Environment}
      Type: TOKEN
      AuthorizerUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${CognitoAuthorizerFunction.Arn}/invocations
      AuthorizerCredentials: !GetAtt ApiGatewayAuthorizerRole.Arn
      AuthorizerResultTtlInSeconds: 300
      IdentitySource: method.request.header.Authorization
      RestApiId: !Ref BackgroundServiceApi

  # Admin Authorizer Lambda Function
  AdminAuthorizerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-admin-authorizer-${Environment}
      CodeUri: src/lambda/
      Handler: admin-authorizer.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 256
      Role: !GetAtt CognitoAuthorizerRole.Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: AdminAuthorizer

  # Lambda Permission for Admin Service API Gateway to invoke admin authorizer
  AdminAuthorizerAdminServicePermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AdminAuthorizerFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AdminServiceApi}/authorizers/*

  AdminServiceCognitoAuthorizer:
    Type: AWS::ApiGateway::Authorizer
    Properties:
      Name: !Sub bayon-coagent-admin-authorizer-${Environment}
      Type: TOKEN
      AuthorizerUri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminAuthorizerFunction.Arn}/invocations
      AuthorizerCredentials: !GetAtt ApiGatewayAuthorizerRole.Arn
      AuthorizerResultTtlInSeconds: 300
      IdentitySource: method.request.header.Authorization
      RestApiId: !Ref AdminServiceApi

  # IAM Role for API Gateway to invoke authorizer
  ApiGatewayAuthorizerRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub bayon-coagent-api-gateway-authorizer-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: InvokeLambdaAuthorizer
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                Resource: !GetAtt CognitoAuthorizerFunction.Arn

  # Usage Plans for different service tiers
  BasicUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Properties:
      UsagePlanName: !Sub bayon-coagent-basic-${Environment}
      Description: Basic usage plan for standard users
      ApiStages:
        - ApiId: !Ref MainRestApi
          Stage: !Ref MainApiStage
      Throttle:
        RateLimit: !If [IsProduction, 100, 10]
        BurstLimit: !If [IsProduction, 200, 20]
      Quota:
        Limit: !If [IsProduction, 10000, 1000]
        Period: DAY

  PremiumUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Properties:
      UsagePlanName: !Sub bayon-coagent-premium-${Environment}
      Description: Premium usage plan for power users
      ApiStages:
        - ApiId: !Ref MainRestApi
          Stage: !Ref MainApiStage
      Throttle:
        RateLimit: !If [IsProduction, 500, 50]
        BurstLimit: !If [IsProduction, 1000, 100]
      Quota:
        Limit: !If [IsProduction, 50000, 5000]
        Period: DAY

  EnterpriseUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Properties:
      UsagePlanName: !Sub bayon-coagent-enterprise-${Environment}
      Description: Enterprise usage plan for high-volume users
      ApiStages:
        - ApiId: !Ref MainRestApi
          Stage: !Ref MainApiStage
      Throttle:
        RateLimit: !If [IsProduction, 2000, 200]
        BurstLimit: !If [IsProduction, 4000, 400]
      Quota:
        Limit: !If [IsProduction, 200000, 20000]
        Period: DAY

  AiServiceUsagePlan:
    Type: AWS::ApiGateway::UsagePlan
    Properties:
      UsagePlanName: !Sub bayon-coagent-ai-service-${Environment}
      Description: Usage plan for AI processing service
      ApiStages:
        - ApiId: !Ref AiServiceApi
          Stage: !Ref AiServiceApiStage
      Throttle:
        RateLimit: !If [IsProduction, 1000, 100]
        BurstLimit: !If [IsProduction, 2000, 200]
      Quota:
        Limit: !If [IsProduction, 100000, 10000]
        Period: DAY

  # Request/Response Models for API validation
  ErrorResponseModel:
    Type: AWS::ApiGateway::Model
    Properties:
      RestApiId: !Ref MainRestApi
      ContentType: application/json
      Name: ErrorResponse
      Schema:
        $schema: http://json-schema.org/draft-04/schema#
        title: Error Response
        type: object
        properties:
          error:
            type: object
            properties:
              code:
                type: string
              message:
                type: string
              details:
                type: object
              traceId:
                type: string
            required:
              - code
              - message
        required:
          - error

  SuccessResponseModel:
    Type: AWS::ApiGateway::Model
    Properties:
      RestApiId: !Ref MainRestApi
      ContentType: application/json
      Name: SuccessResponse
      Schema:
        $schema: http://json-schema.org/draft-04/schema#
        title: Success Response
        type: object
        properties:
          success:
            type: boolean
          data:
            type: object
          message:
            type: string
          traceId:
            type: string
        required:
          - success

  # Request Validator
  RequestValidator:
    Type: AWS::ApiGateway::RequestValidator
    Properties:
      RestApiId: !Ref MainRestApi
      Name: Validate body and parameters
      ValidateRequestBody: true
      ValidateRequestParameters: true

  # ==========================================
  # AWS Secrets Manager for OAuth Credentials
  # ==========================================

  # Google OAuth Credentials Secret
  GoogleOAuthSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub bayon-coagent/oauth/google-${Environment}
      Description: Google OAuth credentials for Business Profile integration
      SecretString: !If
        - IsProduction
        - !Sub |
          {
            "clientId": "",
            "clientSecret": "",
            "redirectUri": "https://yourdomain.com/api/oauth/google/callback"
          }
        - !Sub |
          {
            "clientId": "",
            "clientSecret": "",
            "redirectUri": "http://localhost:3000/api/oauth/google/callback"
          }
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Provider
          Value: Google

  # Facebook OAuth Credentials Secret
  FacebookOAuthSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub bayon-coagent/oauth/facebook-${Environment}
      Description: Facebook OAuth credentials for social media integration
      SecretString: !If
        - IsProduction
        - !Sub |
          {
            "appId": "",
            "appSecret": "",
            "redirectUri": "https://yourdomain.com/api/oauth/facebook/callback"
          }
        - !Sub |
          {
            "appId": "",
            "appSecret": "",
            "redirectUri": "http://localhost:3000/api/oauth/facebook/callback"
          }
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Provider
          Value: Facebook

  # Instagram OAuth Credentials Secret
  InstagramOAuthSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub bayon-coagent/oauth/instagram-${Environment}
      Description: Instagram OAuth credentials for social media integration
      SecretString: !If
        - IsProduction
        - !Sub |
          {
            "appId": "",
            "appSecret": "",
            "redirectUri": "https://yourdomain.com/api/oauth/instagram/callback"
          }
        - !Sub |
          {
            "appId": "",
            "appSecret": "",
            "redirectUri": "http://localhost:3000/api/oauth/instagram/callback"
          }
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Provider
          Value: Instagram

  # LinkedIn OAuth Credentials Secret
  LinkedInOAuthSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub bayon-coagent/oauth/linkedin-${Environment}
      Description: LinkedIn OAuth credentials for social media integration
      SecretString: !If
        - IsProduction
        - !Sub |
          {
            "clientId": "",
            "clientSecret": "",
            "redirectUri": "https://yourdomain.com/api/oauth/linkedin/callback"
          }
        - !Sub |
          {
            "clientId": "",
            "clientSecret": "",
            "redirectUri": "http://localhost:3000/api/oauth/linkedin/callback"
          }
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Provider
          Value: LinkedIn

  # Twitter OAuth Credentials Secret
  TwitterOAuthSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub bayon-coagent/oauth/twitter-${Environment}
      Description: Twitter OAuth credentials for social media integration
      SecretString: !If
        - IsProduction
        - !Sub |
          {
            "apiKey": "",
            "apiSecret": "",
            "bearerToken": "",
            "redirectUri": "https://yourdomain.com/api/oauth/twitter/callback"
          }
        - !Sub |
          {
            "apiKey": "",
            "apiSecret": "",
            "bearerToken": "",
            "redirectUri": "http://localhost:3000/api/oauth/twitter/callback"
          }
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Provider
          Value: Twitter

  # MLS API Credentials Secret
  MLSAPISecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub bayon-coagent/mls/api-credentials-${Environment}
      Description: MLS API credentials for listing data integration
      SecretString: !Sub |
        {
          "mlsgrid": {
            "apiKey": "",
            "apiSecret": "",
            "baseUrl": "https://api.mlsgrid.com/v2"
          },
          "bridgeInteractive": {
            "apiKey": "",
            "baseUrl": "https://api.bridgeinteractive.com/v2"
          }
        }
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Provider
          Value: MLS

  # Secret Rotation Lambda Function
  SecretRotationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-secret-rotation-${Environment}
      CodeUri: src/lambda/
      Handler: secret-rotation.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 256
      Role: !GetAtt SecretRotationRole.Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: SecretRotation

  # IAM Role for Secret Rotation
  SecretRotationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub bayon-coagent-secret-rotation-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SecretRotationAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:DescribeSecret
                  - secretsmanager:GetSecretValue
                  - secretsmanager:PutSecretValue
                  - secretsmanager:UpdateSecretVersionStage
                Resource:
                  - !Ref GoogleOAuthSecret
                  - !Ref FacebookOAuthSecret
                  - !Ref InstagramOAuthSecret
                  - !Ref LinkedInOAuthSecret
                  - !Ref TwitterOAuthSecret
                  - !Ref MLSAPISecret
              - Effect: Allow
                Action:
                  - secretsmanager:GetRandomPassword
                Resource: "*"

  # Secret Rotation Schedule for Google OAuth (90 days)
  GoogleOAuthSecretRotationSchedule:
    Type: AWS::SecretsManager::RotationSchedule
    Properties:
      SecretId: !Ref GoogleOAuthSecret
      RotationLambdaARN: !GetAtt SecretRotationFunction.Arn
      RotationRules:
        AutomaticallyAfterDays: 90

  # Secret Rotation Schedule for Facebook OAuth (90 days)
  FacebookOAuthSecretRotationSchedule:
    Type: AWS::SecretsManager::RotationSchedule
    Properties:
      SecretId: !Ref FacebookOAuthSecret
      RotationLambdaARN: !GetAtt SecretRotationFunction.Arn
      RotationRules:
        AutomaticallyAfterDays: 90

  # Secret Rotation Schedule for Instagram OAuth (90 days)
  InstagramOAuthSecretRotationSchedule:
    Type: AWS::SecretsManager::RotationSchedule
    Properties:
      SecretId: !Ref InstagramOAuthSecret
      RotationLambdaARN: !GetAtt SecretRotationFunction.Arn
      RotationRules:
        AutomaticallyAfterDays: 90

  # Secret Rotation Schedule for LinkedIn OAuth (90 days)
  LinkedInOAuthSecretRotationSchedule:
    Type: AWS::SecretsManager::RotationSchedule
    Properties:
      SecretId: !Ref LinkedInOAuthSecret
      RotationLambdaARN: !GetAtt SecretRotationFunction.Arn
      RotationRules:
        AutomaticallyAfterDays: 90

  # Secret Rotation Schedule for Twitter OAuth (90 days)
  TwitterOAuthSecretRotationSchedule:
    Type: AWS::SecretsManager::RotationSchedule
    Properties:
      SecretId: !Ref TwitterOAuthSecret
      RotationLambdaARN: !GetAtt SecretRotationFunction.Arn
      RotationRules:
        AutomaticallyAfterDays: 90

  # Secret Rotation Schedule for MLS API (90 days)
  MLSAPISecretRotationSchedule:
    Type: AWS::SecretsManager::RotationSchedule
    Properties:
      SecretId: !Ref MLSAPISecret
      RotationLambdaARN: !GetAtt SecretRotationFunction.Arn
      RotationRules:
        AutomaticallyAfterDays: 90

  # Lambda Permission for Secrets Manager to invoke rotation function
  SecretRotationLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SecretRotationFunction
      Action: lambda:InvokeFunction
      Principal: secretsmanager.amazonaws.com

  # ==========================================
  # Integration Service Lambda Functions
  # ==========================================

  # IAM Role for Integration Service Lambda Functions
  IntegrationServiceLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub bayon-coagent-integration-service-lambda-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: IntegrationServiceDynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt DynamoDBTable.Arn
                  - !Sub ${DynamoDBTable.Arn}/index/*
        - PolicyName: IntegrationServiceSecretsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Ref GoogleOAuthSecret
                  - !Ref FacebookOAuthSecret
                  - !Ref InstagramOAuthSecret
                  - !Ref LinkedInOAuthSecret
                  - !Ref TwitterOAuthSecret
                  - !Ref MLSAPISecret
        - PolicyName: IntegrationServiceS3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:PutObject
                  - s3:GetObject
                Resource: !Sub ${StorageBucket.Arn}/*
        - PolicyName: IntegrationServiceCloudWatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/bayon-coagent-integration-*-${Environment}*
        - PolicyName: IntegrationServiceApiGatewayInvoke
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - execute-api:Invoke
                Resource:
                  - !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AiServiceApi}/*
                  - !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${BackgroundServiceApi}/*

  # Google OAuth Lambda Function
  IntegrationGoogleOAuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-integration-google-oauth-${Environment}
      CodeUri: src/lambda/
      Handler: integration-google-oauth.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 512
      Role: !GetAtt IntegrationServiceLambdaRole.Arn
      ReservedConcurrentExecutions: 20
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: IntegrationService
        Function: GoogleOAuth

  # Social Media OAuth Lambda Function
  IntegrationSocialOAuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-integration-social-oauth-${Environment}
      CodeUri: src/lambda/
      Handler: integration-social-oauth.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 512
      Role: !GetAtt IntegrationServiceLambdaRole.Arn
      ReservedConcurrentExecutions: 20
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: IntegrationService
        Function: SocialOAuth

  # MLS Data Sync Lambda Function
  IntegrationMLSSyncFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-integration-mls-sync-${Environment}
      CodeUri: src/lambda/
      Handler: integration-mls-sync.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes for large syncs
      MemorySize: 2048
      Role: !GetAtt IntegrationServiceLambdaRole.Arn
      ReservedConcurrentExecutions: 20
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: IntegrationService
        Function: MLSSync

  # ==========================================
  # Alert Processing Lambda Functions
  # ==========================================

  # Life Event Analysis Lambda (Daily)
  LifeEventProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-life-event-processor-${Environment}
      CodeUri: src/lambda/
      Handler: life-event-processor.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes
      MemorySize: 2048
      Role: !GetAtt ApplicationRole.Arn
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 6 * * ? *) # Daily at 6 AM UTC
            Description: Daily life event analysis
            Enabled: true
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: LifeEventProcessor

  # Competitor Monitoring Lambda (Every 4 hours)
  CompetitorMonitorProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-competitor-monitor-${Environment}
      CodeUri: src/lambda/
      Handler: competitor-monitor-processor.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes
      MemorySize: 2048
      Role: !GetAtt ApplicationRole.Arn
      Events:
        FourHourlySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 */4 * * ? *) # Every 4 hours
            Description: Competitor monitoring every 4 hours
            Enabled: true
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: CompetitorMonitor

  # Neighborhood Trend Detection Lambda (Daily)
  TrendDetectorProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-trend-detector-${Environment}
      CodeUri: src/lambda/
      Handler: trend-detector-processor.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes
      MemorySize: 2048
      Role: !GetAtt ApplicationRole.Arn
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 7 * * ? *) # Daily at 7 AM UTC (1 hour after life events)
            Description: Daily neighborhood trend analysis
            Enabled: true
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: TrendDetector

  # Price Reduction Monitoring Lambda (Every 4 hours)
  PriceReductionProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-price-reduction-monitor-${Environment}
      CodeUri: src/lambda/
      Handler: price-reduction-processor.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes
      MemorySize: 2048
      Role: !GetAtt ApplicationRole.Arn
      Events:
        FourHourlySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(30 */4 * * ? *) # Every 4 hours, offset by 30 minutes from competitor monitoring
            Description: Price reduction monitoring every 4 hours
            Enabled: true
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: PriceReductionMonitor

  # Notification Processing Lambda (Every 15 minutes for queue processing, scheduled for digests)
  NotificationProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-notification-processor-${Environment}
      CodeUri: src/lambda/
      Handler: notification-processor.handler
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          SES_FROM_EMAIL: !Sub noreply@bayoncoagent.com
          SES_REGION: !Ref AWS::Region
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable
        - SESCrudPolicy:
            IdentityName: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendBulkTemplatedEmail
                - ses:CreateTemplate
                - ses:UpdateTemplate
                - ses:GetTemplate
                - ses:ListTemplates
              Resource: "*"
      Events:
        # Process notification queue every 15 minutes
        QueueProcessingSchedule:
          Type: Schedule
          Properties:
            Schedule: rate(15 minutes)
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "type": "process-queue"
                }
              }
        # Daily digest at 9 AM UTC (adjust as needed)
        DailyDigestSchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 9 * * ? *)
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "type": "daily-digest"
                }
              }
        # Weekly digest on Mondays at 9 AM UTC
        WeeklyDigestSchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 9 ? * MON *)
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "type": "weekly-digest"
                }
              }
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt NotificationProcessorDLQ.Arn

  # Dead Letter Queue for notification processor
  NotificationProcessorDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub bayon-coagent-notification-processor-dlq-${Environment}
      MessageRetentionPeriod: 1209600 # 14 days

  # Notification Digest Generator Lambda (Daily and Weekly digests)
  NotificationDigestGeneratorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-notification-digest-generator-${Environment}
      CodeUri: src/lambda/
      Handler: notification-digest-generator.handler
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          FROM_EMAIL: !Sub noreply@bayoncoagent.com
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable
        - SESCrudPolicy:
            IdentityName: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendBulkTemplatedEmail
              Resource: "*"
      Events:
        # Daily digest at 9 AM UTC
        DailyDigestSchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 9 * * ? *)
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "frequency": "daily"
                }
              }
        # Weekly digest on Mondays at 9 AM UTC
        WeeklyDigestSchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 9 ? * MON *)
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "frequency": "weekly"
                }
              }
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt NotificationProcessorDLQ.Arn
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: NotificationDigestGenerator

  # Notification Retry Processor Lambda (Retry failed deliveries)
  NotificationRetryProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-notification-retry-processor-${Environment}
      CodeUri: src/lambda/
      Handler: notification-retry-processor.handler
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          NOTIFICATION_DLQ_URL: !Ref NotificationProcessorDLQ
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable
        - SQSSendMessagePolicy:
            QueueName: !GetAtt NotificationProcessorDLQ.QueueName
        - SESCrudPolicy:
            IdentityName: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
              Resource: "*"
      Events:
        # Retry failed deliveries every 30 minutes
        RetrySchedule:
          Type: Schedule
          Properties:
            Schedule: rate(30 minutes)
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "maxAge": 24,
                  "maxAttempts": 6
                }
              }
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt NotificationProcessorDLQ.Arn
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: NotificationRetryProcessor

  # Notification Cleanup and Maintenance Lambda
  NotificationCleanupMaintenanceFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-notification-cleanup-maintenance-${Environment}
      CodeUri: src/lambda/
      Handler: notification-cleanup-maintenance.handler
      Timeout: 900
      MemorySize: 512
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Scan
                - dynamodb:Query
                - dynamodb:BatchWriteItem
              Resource:
                - !GetAtt DynamoDBTable.Arn
      Events:
        # Run cleanup daily at 2 AM UTC
        CleanupSchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 2 * * ? *)
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "tasks": ["all"],
                  "dryRun": false
                }
              }
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt NotificationProcessorDLQ.Arn
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: NotificationCleanupMaintenance

  # ==========================================
  # AI Processing Service SQS Queues
  # ==========================================

  # AI Job Request Queue - for submitting AI processing jobs
  AiJobRequestQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub bayon-coagent-ai-job-request-${Environment}
      MessageRetentionPeriod: 1209600 # 14 days
      VisibilityTimeout: 900 # 15 minutes (matches Lambda timeout)
      ReceiveMessageWaitTimeSeconds: 20 # Long polling
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt AiJobRequestDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Service
          Value: AIProcessing

  # AI Job Request Dead Letter Queue
  AiJobRequestDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub bayon-coagent-ai-job-request-dlq-${Environment}
      MessageRetentionPeriod: 1209600 # 14 days
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Service
          Value: AIProcessing

  # AI Job Response Queue - for receiving AI processing results
  AiJobResponseQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub bayon-coagent-ai-job-response-${Environment}
      MessageRetentionPeriod: 1209600 # 14 days
      VisibilityTimeout: 300 # 5 minutes
      ReceiveMessageWaitTimeSeconds: 20 # Long polling
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt AiJobResponseDLQ.Arn
        maxReceiveCount: 3
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Service
          Value: AIProcessing

  # AI Job Response Dead Letter Queue
  AiJobResponseDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub bayon-coagent-ai-job-response-dlq-${Environment}
      MessageRetentionPeriod: 1209600 # 14 days
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Service
          Value: AIProcessing

  # ==========================================
  # EventBridge Custom Event Bus
  # ==========================================

  # Custom Event Bus for Application Events
  ApplicationEventBus:
    Type: AWS::Events::EventBus
    Properties:
      Name: !Sub bayon-coagent-events-${Environment}
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent

  # Event Archive for Replay Capability
  ApplicationEventArchive:
    Type: AWS::Events::Archive
    Properties:
      ArchiveName: !Sub bayon-coagent-event-archive-${Environment}
      SourceArn: !GetAtt ApplicationEventBus.Arn
      Description: Archive of all application events for replay capability
      RetentionDays: !If [IsProduction, 90, 30]
      EventPattern:
        source:
          - prefix: "bayon.coagent"

  # Dead Letter Queue for Failed Events
  EventBridgeDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub bayon-coagent-eventbridge-dlq-${Environment}
      MessageRetentionPeriod: 1209600 # 14 days
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Service
          Value: EventBridge

  # Event Schema Registry
  EventSchemaRegistry:
    Type: AWS::EventSchemas::Registry
    Properties:
      RegistryName: !Sub bayon-coagent-schemas-${Environment}
      Description: Schema registry for Bayon CoAgent application events
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent

  # User Created Event Schema
  UserCreatedEventSchema:
    Type: AWS::EventSchemas::Schema
    Properties:
      RegistryName: !Ref EventSchemaRegistry
      SchemaName: bayon.coagent.user.created
      Type: OpenApi3
      Description: Schema for user.created events
      Content: |
        {
          "openapi": "3.0.0",
          "info": {
            "version": "1.0.0",
            "title": "User Created Event"
          },
          "paths": {},
          "components": {
            "schemas": {
              "UserCreatedEvent": {
                "type": "object",
                "required": ["version", "id", "detail-type", "source", "account", "time", "region", "detail"],
                "properties": {
                  "version": {"type": "string"},
                  "id": {"type": "string"},
                  "detail-type": {"type": "string", "enum": ["User Created"]},
                  "source": {"type": "string", "enum": ["bayon.coagent.user"]},
                  "account": {"type": "string"},
                  "time": {"type": "string", "format": "date-time"},
                  "region": {"type": "string"},
                  "detail": {
                    "type": "object",
                    "required": ["userId", "email", "createdAt"],
                    "properties": {
                      "userId": {"type": "string"},
                      "email": {"type": "string"},
                      "createdAt": {"type": "string", "format": "date-time"},
                      "traceId": {"type": "string"}
                    }
                  }
                }
              }
            }
          }
        }

  # Content Published Event Schema
  ContentPublishedEventSchema:
    Type: AWS::EventSchemas::Schema
    Properties:
      RegistryName: !Ref EventSchemaRegistry
      SchemaName: bayon.coagent.content.published
      Type: OpenApi3
      Description: Schema for content.published events
      Content: |
        {
          "openapi": "3.0.0",
          "info": {
            "version": "1.0.0",
            "title": "Content Published Event"
          },
          "paths": {},
          "components": {
            "schemas": {
              "ContentPublishedEvent": {
                "type": "object",
                "required": ["version", "id", "detail-type", "source", "account", "time", "region", "detail"],
                "properties": {
                  "version": {"type": "string"},
                  "id": {"type": "string"},
                  "detail-type": {"type": "string", "enum": ["Content Published"]},
                  "source": {"type": "string", "enum": ["bayon.coagent.content"]},
                  "account": {"type": "string"},
                  "time": {"type": "string", "format": "date-time"},
                  "region": {"type": "string"},
                  "detail": {
                    "type": "object",
                    "required": ["contentId", "userId", "contentType", "platform", "publishedAt"],
                    "properties": {
                      "contentId": {"type": "string"},
                      "userId": {"type": "string"},
                      "contentType": {"type": "string"},
                      "platform": {"type": "string"},
                      "publishedAt": {"type": "string", "format": "date-time"},
                      "traceId": {"type": "string"}
                    }
                  }
                }
              }
            }
          }
        }

  # AI Job Completed Event Schema
  AiJobCompletedEventSchema:
    Type: AWS::EventSchemas::Schema
    Properties:
      RegistryName: !Ref EventSchemaRegistry
      SchemaName: bayon.coagent.ai.job.completed
      Type: OpenApi3
      Description: Schema for ai.job.completed events
      Content: |
        {
          "openapi": "3.0.0",
          "info": {
            "version": "1.0.0",
            "title": "AI Job Completed Event"
          },
          "paths": {},
          "components": {
            "schemas": {
              "AiJobCompletedEvent": {
                "type": "object",
                "required": ["version", "id", "detail-type", "source", "account", "time", "region", "detail"],
                "properties": {
                  "version": {"type": "string"},
                  "id": {"type": "string"},
                  "detail-type": {"type": "string", "enum": ["AI Job Completed"]},
                  "source": {"type": "string", "enum": ["bayon.coagent.ai"]},
                  "account": {"type": "string"},
                  "time": {"type": "string", "format": "date-time"},
                  "region": {"type": "string"},
                  "detail": {
                    "type": "object",
                    "required": ["jobId", "userId", "jobType", "status", "completedAt"],
                    "properties": {
                      "jobId": {"type": "string"},
                      "userId": {"type": "string"},
                      "jobType": {"type": "string"},
                      "status": {"type": "string", "enum": ["completed", "failed"]},
                      "completedAt": {"type": "string", "format": "date-time"},
                      "traceId": {"type": "string"}
                    }
                  }
                }
              }
            }
          }
        }

  # Integration Sync Completed Event Schema
  IntegrationSyncCompletedEventSchema:
    Type: AWS::EventSchemas::Schema
    Properties:
      RegistryName: !Ref EventSchemaRegistry
      SchemaName: bayon.coagent.integration.sync.completed
      Type: OpenApi3
      Description: Schema for integration.sync.completed events
      Content: |
        {
          "openapi": "3.0.0",
          "info": {
            "version": "1.0.0",
            "title": "Integration Sync Completed Event"
          },
          "paths": {},
          "components": {
            "schemas": {
              "IntegrationSyncCompletedEvent": {
                "type": "object",
                "required": ["version", "id", "detail-type", "source", "account", "time", "region", "detail"],
                "properties": {
                  "version": {"type": "string"},
                  "id": {"type": "string"},
                  "detail-type": {"type": "string", "enum": ["Integration Sync Completed"]},
                  "source": {"type": "string", "enum": ["bayon.coagent.integration"]},
                  "account": {"type": "string"},
                  "time": {"type": "string", "format": "date-time"},
                  "region": {"type": "string"},
                  "detail": {
                    "type": "object",
                    "required": ["syncId", "userId", "provider", "status", "completedAt"],
                    "properties": {
                      "syncId": {"type": "string"},
                      "userId": {"type": "string"},
                      "provider": {"type": "string"},
                      "status": {"type": "string", "enum": ["completed", "failed"]},
                      "itemsSynced": {"type": "number"},
                      "completedAt": {"type": "string", "format": "date-time"},
                      "traceId": {"type": "string"}
                    }
                  }
                }
              }
            }
          }
        }

  # ==========================================
  # EventBridge Rules for Background Processing
  # ==========================================

  # Rule to trigger Life Event Processor on user.created events
  LifeEventProcessorRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub bayon-coagent-life-event-processor-${Environment}
      Description: Trigger life event processor on user.created events
      EventBusName: !Ref ApplicationEventBus
      State: ENABLED
      EventPattern:
        source:
          - bayon.coagent.user
        detail-type:
          - User Created
      Targets:
        - Arn: !GetAtt LifeEventProcessorFunction.Arn
          Id: LifeEventProcessorTarget
          DeadLetterConfig:
            Arn: !GetAtt EventBridgeDLQ.Arn
          RetryPolicy:
            MaximumRetryAttempts: 2
            MaximumEventAgeInSeconds: 3600

  # Permission for EventBridge to invoke Life Event Processor
  LifeEventProcessorEventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref LifeEventProcessorFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt LifeEventProcessorRule.Arn

  # Rule to trigger Competitor Monitor on content.published events
  CompetitorMonitorRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub bayon-coagent-competitor-monitor-${Environment}
      Description: Trigger competitor monitor on content.published events
      EventBusName: !Ref ApplicationEventBus
      State: ENABLED
      EventPattern:
        source:
          - bayon.coagent.content
        detail-type:
          - Content Published
      Targets:
        - Arn: !GetAtt CompetitorMonitorProcessorFunction.Arn
          Id: CompetitorMonitorTarget
          DeadLetterConfig:
            Arn: !GetAtt EventBridgeDLQ.Arn
          RetryPolicy:
            MaximumRetryAttempts: 2
            MaximumEventAgeInSeconds: 3600

  # Permission for EventBridge to invoke Competitor Monitor
  CompetitorMonitorEventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref CompetitorMonitorProcessorFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt CompetitorMonitorRule.Arn

  # Rule to trigger Trend Detector on integration.sync.completed events
  TrendDetectorRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub bayon-coagent-trend-detector-${Environment}
      Description: Trigger trend detector on integration.sync.completed events
      EventBusName: !Ref ApplicationEventBus
      State: ENABLED
      EventPattern:
        source:
          - bayon.coagent.integration
        detail-type:
          - Integration Sync Completed
        detail:
          provider:
            - mls
      Targets:
        - Arn: !GetAtt TrendDetectorProcessorFunction.Arn
          Id: TrendDetectorTarget
          DeadLetterConfig:
            Arn: !GetAtt EventBridgeDLQ.Arn
          RetryPolicy:
            MaximumRetryAttempts: 2
            MaximumEventAgeInSeconds: 3600

  # Permission for EventBridge to invoke Trend Detector
  TrendDetectorEventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref TrendDetectorProcessorFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt TrendDetectorRule.Arn

  # Rule to trigger Price Reduction Monitor on integration.sync.completed events
  PriceReductionMonitorRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub bayon-coagent-price-reduction-monitor-${Environment}
      Description: Trigger price reduction monitor on integration.sync.completed events
      EventBusName: !Ref ApplicationEventBus
      State: ENABLED
      EventPattern:
        source:
          - bayon.coagent.integration
        detail-type:
          - Integration Sync Completed
        detail:
          provider:
            - mls
      Targets:
        - Arn: !GetAtt PriceReductionProcessorFunction.Arn
          Id: PriceReductionMonitorTarget
          DeadLetterConfig:
            Arn: !GetAtt EventBridgeDLQ.Arn
          RetryPolicy:
            MaximumRetryAttempts: 2
            MaximumEventAgeInSeconds: 3600

  # Permission for EventBridge to invoke Price Reduction Monitor
  PriceReductionMonitorEventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PriceReductionProcessorFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt PriceReductionMonitorRule.Arn

  # Rule to trigger Notification Processor on various events
  NotificationProcessorRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub bayon-coagent-notification-processor-${Environment}
      Description: Trigger notification processor on various application events
      EventBusName: !Ref ApplicationEventBus
      State: ENABLED
      EventPattern:
        source:
          - bayon.coagent.user
          - bayon.coagent.content
          - bayon.coagent.ai
          - bayon.coagent.integration
        detail-type:
          - User Created
          - Content Published
          - AI Job Completed
          - Integration Sync Completed
      Targets:
        - Arn: !GetAtt NotificationProcessorFunction.Arn
          Id: NotificationProcessorTarget
          DeadLetterConfig:
            Arn: !GetAtt EventBridgeDLQ.Arn
          RetryPolicy:
            MaximumRetryAttempts: 2
            MaximumEventAgeInSeconds: 3600

  # Permission for EventBridge to invoke Notification Processor
  NotificationProcessorEventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref NotificationProcessorFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt NotificationProcessorRule.Arn

  # Rule to trigger Content Publishing on ai.job.completed events
  ContentPublishingRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub bayon-coagent-content-publishing-${Environment}
      Description: Trigger content publishing on ai.job.completed events
      EventBusName: !Ref ApplicationEventBus
      State: ENABLED
      EventPattern:
        source:
          - bayon.coagent.ai
        detail-type:
          - AI Job Completed
        detail:
          status:
            - completed
      Targets:
        - Arn: !GetAtt PublishScheduledContentFunction.Arn
          Id: ContentPublishingTarget
          DeadLetterConfig:
            Arn: !GetAtt EventBridgeDLQ.Arn
          RetryPolicy:
            MaximumRetryAttempts: 2
            MaximumEventAgeInSeconds: 3600

  # Permission for EventBridge to invoke Content Publishing
  ContentPublishingEventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PublishScheduledContentFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt ContentPublishingRule.Arn

  # Rule to trigger Analytics Sync on content.published events
  AnalyticsSyncRule:
    Type: AWS::Events::Rule
    Properties:
      Name: !Sub bayon-coagent-analytics-sync-${Environment}
      Description: Trigger analytics sync on content.published events
      EventBusName: !Ref ApplicationEventBus
      State: ENABLED
      EventPattern:
        source:
          - bayon.coagent.content
        detail-type:
          - Content Published
      Targets:
        - Arn: !GetAtt SyncSocialAnalyticsFunction.Arn
          Id: AnalyticsSyncTarget
          DeadLetterConfig:
            Arn: !GetAtt EventBridgeDLQ.Arn
          RetryPolicy:
            MaximumRetryAttempts: 2
            MaximumEventAgeInSeconds: 3600

  # Permission for EventBridge to invoke Analytics Sync
  AnalyticsSyncEventPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SyncSocialAnalyticsFunction
      Action: lambda:InvokeFunction
      Principal: events.amazonaws.com
      SourceArn: !GetAtt AnalyticsSyncRule.Arn

  # ==========================================
  # Content Workflow Lambda Functions
  # ==========================================

  # Dead Letter Queues for Content Workflow Functions
  PublishScheduledContentDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub bayon-coagent-publish-scheduled-content-dlq-${Environment}
      MessageRetentionPeriod: 1209600 # 14 days
      VisibilityTimeout: 60
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Function
          Value: PublishScheduledContent

  SyncSocialAnalyticsDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub bayon-coagent-sync-social-analytics-dlq-${Environment}
      MessageRetentionPeriod: 1209600 # 14 days
      VisibilityTimeout: 60
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Function
          Value: SyncSocialAnalytics

  CalculateOptimalTimesDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub bayon-coagent-calculate-optimal-times-dlq-${Environment}
      MessageRetentionPeriod: 1209600 # 14 days
      VisibilityTimeout: 60
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent
        - Key: Function
          Value: CalculateOptimalTimes

  # Enhanced IAM Role for Content Workflow Lambda Functions
  ContentWorkflowLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub bayon-coagent-content-workflow-lambda-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: ContentWorkflowDynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                Resource:
                  - !GetAtt DynamoDBTable.Arn
                  - !Sub ${DynamoDBTable.Arn}/index/GSI1
                  - !Sub ${DynamoDBTable.Arn}/index/GSI2
                  - !Sub ${DynamoDBTable.Arn}/index/GSI3
                  - !Sub ${DynamoDBTable.Arn}/index/GSI4
                  - !Sub ${DynamoDBTable.Arn}/index/EntityTypeIndex
                  - !Sub ${DynamoDBTable.Arn}/index/UserIndex
        - PolicyName: ContentWorkflowCloudWatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/bayon-coagent-*-${Environment}*
        - PolicyName: ContentWorkflowSQSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:GetQueueAttributes
                Resource:
                  - !GetAtt PublishScheduledContentDLQ.Arn
                  - !GetAtt SyncSocialAnalyticsDLQ.Arn
                  - !GetAtt CalculateOptimalTimesDLQ.Arn
        - PolicyName: ContentWorkflowCloudWatchMetrics
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:PutMetricData
                  - cloudwatch:GetMetricStatistics
                  - cloudwatch:ListMetrics
                Resource: "*"
                Condition:
                  StringEquals:
                    cloudwatch:namespace: "BayonCoAgent/ContentWorkflow"
        - PolicyName: ContentWorkflowSecretsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:bayon-coagent/oauth/*
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:GetParametersByPath
                Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/bayon-coagent/${Environment}/*
        - PolicyName: ContentWorkflowApiGatewayInvoke
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - execute-api:Invoke
                Resource:
                  - !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AiServiceApi}/*
                  - !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${IntegrationServiceApi}/*

  # Calculate Optimal Times Lambda (Weekly)
  CalculateOptimalTimesFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-calculate-optimal-times-${Environment}
      CodeUri: src/lambda/
      Handler: calculate-optimal-times.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes
      MemorySize: 3008 # High memory for ML computations
      Role: !GetAtt ContentWorkflowLambdaRole.Arn
      Events:
        WeeklySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 2 ? * SUN *) # Weekly on Sundays at 2 AM UTC
            Description: Weekly optimal times calculation with ML analysis and adaptive frequency
            Enabled: true
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "maxUsers": 50,
                  "channels": ["facebook", "instagram", "linkedin", "twitter"],
                  "contentTypes": ["social_media", "blog_post", "market_update"],
                  "minSampleSize": 20,
                  "forceRecalculation": false
                }
              }
            DeadLetterConfig:
              Arn: !GetAtt CalculateOptimalTimesDLQ.Arn
            RetryPolicy:
              MaximumRetryAttempts: 3
      Environment:
        Variables:
          LOG_LEVEL: INFO
          CLOUDWATCH_NAMESPACE: BayonCoAgent/ContentWorkflow
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
          S3_BUCKET_NAME: !Ref StorageBucket
          LAMBDA_VERSION: "1.0.0"
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: CalculateOptimalTimes

  # Publish Scheduled Content Lambda (Every 5 minutes)
  PublishScheduledContentFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-publish-scheduled-content-${Environment}
      CodeUri: src/lambda/
      Handler: publish-scheduled-content.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes
      MemorySize: 2048
      Role: !GetAtt ContentWorkflowLambdaRole.Arn
      Events:
        PublishingSchedule:
          Type: Schedule
          Properties:
            Schedule: rate(5 minutes) # Every 5 minutes with dead letter queue
            Description: Automated content publishing every 5 minutes with comprehensive error handling
            Enabled: true
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "maxItems": 100
                }
              }
            DeadLetterConfig:
              Arn: !GetAtt PublishScheduledContentDLQ.Arn
            RetryPolicy:
              MaximumRetryAttempts: 2
      Environment:
        Variables:
          LOG_LEVEL: INFO
          CLOUDWATCH_NAMESPACE: BayonCoAgent/ContentWorkflow
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
          S3_BUCKET_NAME: !Ref StorageBucket
          LAMBDA_VERSION: "1.0.0"
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: PublishScheduledContent

  # Sync Social Analytics Lambda (Daily)
  SyncSocialAnalyticsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-sync-social-analytics-${Environment}
      CodeUri: src/lambda/
      Handler: sync-social-analytics.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes
      MemorySize: 2048
      Role: !GetAtt ContentWorkflowLambdaRole.Arn
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 2 * * ? *) # Daily at 2 AM UTC with timezone awareness
            Description: Daily social media analytics synchronization with timezone awareness and rate limiting
            Enabled: true
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "maxUsers": 100,
                  "channels": ["facebook", "instagram", "linkedin", "twitter"],
                  "forceSync": false
                }
              }
            DeadLetterConfig:
              Arn: !GetAtt SyncSocialAnalyticsDLQ.Arn
            RetryPolicy:
              MaximumRetryAttempts: 3
      Environment:
        Variables:
          LOG_LEVEL: INFO
          CLOUDWATCH_NAMESPACE: BayonCoAgent/ContentWorkflow
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
          S3_BUCKET_NAME: !Ref StorageBucket
          LAMBDA_VERSION: "1.0.0"
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: SyncSocialAnalytics

  # ==========================================
  # Stripe Subscription Handler Lambda
  # ==========================================
  StripeSubscriptionHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-stripe-subscription-handler-${Environment}
      CodeUri: src/lambda/
      Handler: stripe-subscription-handler.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 512
      Role: !GetAtt ApplicationRole.Arn
      Events:
        StripeSubscriptionCreated:
          Type: EventBridgeRule
          Properties:
            EventBusName: aws.partner/stripe.com/ed_test_61ThQU3sr9KLkWPGq16ThPlt3iSQLw25fKzPmC3uK2lk
            Pattern:
              source:
                - aws.partner/stripe.com
              detail-type:
                - Stripe Event
              detail:
                type:
                  - customer.subscription.created
                  - customer.subscription.updated
                  - customer.subscription.deleted
                  - invoice.payment_succeeded
                  - invoice.payment_failed
            RetryPolicy:
              MaximumRetryAttempts: 3
            DeadLetterConfig:
              Arn: !GetAtt StripeEventDLQ.Arn
      Environment:
        Variables:
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
          STRIPE_SECRET_KEY: "{{resolve:secretsmanager:bayon-stripe-secret:SecretString:secret_key}}"
          NODE_ENV: !Ref Environment
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: StripeSubscriptionHandler

  # Dead Letter Queue for failed Stripe events
  StripeEventDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub bayon-stripe-events-dlq-${Environment}
      MessageRetentionPeriod: 1209600
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent

  # CloudWatch Alarm for Stripe DLQ
  StripeEventDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub bayon-stripe-events-dlq-alarm-${Environment}
      AlarmDescription: Alert when Stripe events fail and land in DLQ
      MetricName: ApproximateNumberOfMessagesVisible
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt StripeEventDLQ.QueueName
      TreatMissingData: notBreaching
      AlarmActions: !If
        - HasAlarmEmail
        - - !Ref AlarmTopic
        - !Ref AWS::NoValue

  # Stripe Secret in Secrets Manager
  StripeSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub bayon-stripe-secret-${Environment}
      Description: Stripe API secret key
      SecretString: !Sub |
        {
          "secret_key": "sk_test_placeholder"
        }
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent

  # ==========================================
  # AI Processing Service Lambda Functions
  # ==========================================

  # IAM Role for AI Processing Lambda Functions
  AiProcessingLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub bayon-coagent-ai-processing-lambda-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: AiProcessingDynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                Resource:
                  - !GetAtt DynamoDBTable.Arn
                  - !Sub ${DynamoDBTable.Arn}/index/*
        - PolicyName: AiProcessingSQSAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                Resource:
                  - !GetAtt AiJobRequestQueue.Arn
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource:
                  - !GetAtt AiJobResponseQueue.Arn
                  - !GetAtt AiJobRequestDLQ.Arn
        - PolicyName: AiProcessingBedrockAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                Resource:
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-*
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-*
        - PolicyName: AiProcessingCloudWatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/bayon-coagent-ai-*-${Environment}*
        - PolicyName: AiProcessingApiGatewayInvoke
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - execute-api:Invoke
                Resource:
                  - !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${IntegrationServiceApi}/*
                  - !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${BackgroundServiceApi}/*

  # Blog Post Generation Lambda
  AiBlogPostGeneratorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-ai-blog-post-generator-${Environment}
      CodeUri: src/lambda/
      Handler: ai-blog-post-generator.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes
      MemorySize: 3008 # 3GB for AI processing
      Role: !GetAtt AiProcessingLambdaRole.Arn
      ReservedConcurrentExecutions: 50
      Environment:
        Variables:
          LOG_LEVEL: INFO
          AI_JOB_RESPONSE_QUEUE_URL: !Ref AiJobResponseQueue
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt AiJobRequestQueue.Arn
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 5
            FunctionResponseTypes:
              - ReportBatchItemFailures
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AIProcessing
        Function: BlogPostGenerator

  # Social Media Post Generation Lambda
  AiSocialMediaGeneratorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-ai-social-media-generator-${Environment}
      CodeUri: src/lambda/
      Handler: ai-social-media-generator.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes
      MemorySize: 3008 # 3GB for AI processing
      Role: !GetAtt AiProcessingLambdaRole.Arn
      ReservedConcurrentExecutions: 50
      Environment:
        Variables:
          LOG_LEVEL: INFO
          AI_JOB_RESPONSE_QUEUE_URL: !Ref AiJobResponseQueue
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt AiJobRequestQueue.Arn
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 5
            FunctionResponseTypes:
              - ReportBatchItemFailures
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AIProcessing
        Function: SocialMediaGenerator

  # Listing Description Generation Lambda
  AiListingDescriptionGeneratorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-ai-listing-description-generator-${Environment}
      CodeUri: src/lambda/
      Handler: ai-listing-description-generator.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes
      MemorySize: 3008 # 3GB for AI processing
      Role: !GetAtt AiProcessingLambdaRole.Arn
      ReservedConcurrentExecutions: 50
      Environment:
        Variables:
          LOG_LEVEL: INFO
          AI_JOB_RESPONSE_QUEUE_URL: !Ref AiJobResponseQueue
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt AiJobRequestQueue.Arn
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 5
            FunctionResponseTypes:
              - ReportBatchItemFailures
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AIProcessing
        Function: ListingDescriptionGenerator

  # Market Update Generation Lambda
  AiMarketUpdateGeneratorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-ai-market-update-generator-${Environment}
      CodeUri: src/lambda/
      Handler: ai-market-update-generator.handler
      Runtime: nodejs22.x
      Timeout: 900 # 15 minutes
      MemorySize: 3008 # 3GB for AI processing
      Role: !GetAtt AiProcessingLambdaRole.Arn
      ReservedConcurrentExecutions: 50
      Environment:
        Variables:
          LOG_LEVEL: INFO
          AI_JOB_RESPONSE_QUEUE_URL: !Ref AiJobResponseQueue
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt AiJobRequestQueue.Arn
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 5
            FunctionResponseTypes:
              - ReportBatchItemFailures
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AIProcessing
        Function: MarketUpdateGenerator

  # ==========================================
  # Admin Service Lambda Functions
  # ==========================================

  # IAM Role for Admin Service Lambda Functions
  AdminServiceLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub bayon-coagent-admin-service-lambda-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess
      Policies:
        - PolicyName: AdminServiceCognitoAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:ListUsers
                  - cognito-idp:AdminGetUser
                  - cognito-idp:AdminUpdateUserAttributes
                  - cognito-idp:AdminDeleteUser
                Resource: !GetAtt UserPool.Arn
        - PolicyName: AdminServiceDynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                  - dynamodb:Scan
                Resource:
                  - !GetAtt DynamoDBTable.Arn
                  - !Sub ${DynamoDBTable.Arn}/index/*
        - PolicyName: AdminServiceCloudWatchAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cloudwatch:GetMetricStatistics
                  - cloudwatch:ListMetrics
                  - cloudwatch:DescribeAlarms
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                  - logs:FilterLogEvents
                Resource: "*"
        - PolicyName: AdminServiceLambdaAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - lambda:ListFunctions
                  - lambda:GetFunction
                  - lambda:GetFunctionConfiguration
                Resource: "*"
        - PolicyName: AdminServiceDynamoDBDescribe
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:DescribeTable
                Resource: !GetAtt DynamoDBTable.Arn

  # Admin User Management Lambda
  AdminUserManagementFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-admin-user-management-${Environment}
      CodeUri: src/lambda/
      Handler: admin-user-management.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 512
      Role: !GetAtt AdminServiceLambdaRole.Arn
      ReservedConcurrentExecutions: 10
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AdminService
        Function: UserManagement

  # Admin System Configuration Lambda
  AdminSystemConfigFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-admin-system-config-${Environment}
      CodeUri: src/lambda/
      Handler: admin-system-config.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 512
      Role: !GetAtt AdminServiceLambdaRole.Arn
      ReservedConcurrentExecutions: 10
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AdminService
        Function: SystemConfig

  # Admin Monitoring Dashboard Lambda
  AdminMonitoringDashboardFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-admin-monitoring-dashboard-${Environment}
      CodeUri: src/lambda/
      Handler: admin-monitoring-dashboard.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 512
      Role: !GetAtt AdminServiceLambdaRole.Arn
      ReservedConcurrentExecutions: 10
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AdminService
        Function: MonitoringDashboard

  # Admin Audit Log Query Lambda
  AdminAuditLogQueryFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-admin-audit-log-query-${Environment}
      CodeUri: src/lambda/
      Handler: admin-audit-log-query.handler
      Runtime: nodejs22.x
      Timeout: 30
      MemorySize: 512
      Role: !GetAtt AdminServiceLambdaRole.Arn
      ReservedConcurrentExecutions: 10
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AdminService
        Function: AuditLogQuery

  # ==========================================
  # Admin Service API Gateway Resources
  # ==========================================

  # /users resource
  AdminServiceUsersResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !GetAtt AdminServiceApi.RootResourceId
      PathPart: users

  # GET /users - List users
  AdminServiceListUsersMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceUsersResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminUserManagementFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /users/{username} resource
  AdminServiceUserIdResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !Ref AdminServiceUsersResource
      PathPart: "{username}"

  # GET /users/{username} - Get user
  AdminServiceGetUserMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceUserIdResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      RequestParameters:
        method.request.path.username: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminUserManagementFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # PUT /users/{username} - Update user
  AdminServiceUpdateUserMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceUserIdResource
      HttpMethod: PUT
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      RequestParameters:
        method.request.path.username: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminUserManagementFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # DELETE /users/{username} - Delete user
  AdminServiceDeleteUserMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceUserIdResource
      HttpMethod: DELETE
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      RequestParameters:
        method.request.path.username: true
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminUserManagementFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /config resource
  AdminServiceConfigResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !GetAtt AdminServiceApi.RootResourceId
      PathPart: config

  # GET /config - Get configuration
  AdminServiceGetConfigMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceConfigResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminSystemConfigFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # PUT /config - Update configuration
  AdminServiceUpdateConfigMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceConfigResource
      HttpMethod: PUT
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminSystemConfigFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /config/history resource
  AdminServiceConfigHistoryResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !Ref AdminServiceConfigResource
      PathPart: history

  # GET /config/history - Get configuration history
  AdminServiceGetConfigHistoryMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceConfigHistoryResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminSystemConfigFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /dashboard resource
  AdminServiceDashboardResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !GetAtt AdminServiceApi.RootResourceId
      PathPart: dashboard

  # /dashboard/overview resource
  AdminServiceDashboardOverviewResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !Ref AdminServiceDashboardResource
      PathPart: overview

  # GET /dashboard/overview - Get dashboard overview
  AdminServiceGetDashboardOverviewMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceDashboardOverviewResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminMonitoringDashboardFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /dashboard/metrics resource
  AdminServiceDashboardMetricsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !Ref AdminServiceDashboardResource
      PathPart: metrics

  # GET /dashboard/metrics - Get metrics
  AdminServiceGetMetricsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceDashboardMetricsResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminMonitoringDashboardFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /dashboard/services resource
  AdminServiceDashboardServicesResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !Ref AdminServiceDashboardResource
      PathPart: services

  # GET /dashboard/services - Get services
  AdminServiceGetServicesMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceDashboardServicesResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminMonitoringDashboardFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /dashboard/errors resource
  AdminServiceDashboardErrorsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !Ref AdminServiceDashboardResource
      PathPart: errors

  # GET /dashboard/errors - Get errors
  AdminServiceGetErrorsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceDashboardErrorsResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminMonitoringDashboardFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /audit-logs resource
  AdminServiceAuditLogsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !GetAtt AdminServiceApi.RootResourceId
      PathPart: audit-logs

  # GET /audit-logs - Query audit logs
  AdminServiceQueryAuditLogsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceAuditLogsResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminAuditLogQueryFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # /audit-logs/streams resource
  AdminServiceAuditLogsStreamsResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref AdminServiceApi
      ParentId: !Ref AdminServiceAuditLogsResource
      PathPart: streams

  # GET /audit-logs/streams - Get log streams
  AdminServiceGetLogStreamsMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref AdminServiceApi
      ResourceId: !Ref AdminServiceAuditLogsStreamsResource
      HttpMethod: GET
      AuthorizationType: CUSTOM
      AuthorizerId: !Ref AdminServiceCognitoAuthorizer
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${AdminAuditLogQueryFunction.Arn}/invocations
      MethodResponses:
        - StatusCode: 200

  # Lambda Permissions for API Gateway to invoke Admin Service functions
  AdminUserManagementLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AdminUserManagementFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AdminServiceApi}/*

  AdminSystemConfigLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AdminSystemConfigFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AdminServiceApi}/*

  AdminMonitoringDashboardLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AdminMonitoringDashboardFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AdminServiceApi}/*

  AdminAuditLogQueryLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref AdminAuditLogQueryFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${AdminServiceApi}/*

  # Update Admin Service API Gateway Deployment to include new methods
  AdminServiceApiDeploymentUpdate:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - AdminServiceHealthMethod
      - AdminServiceListUsersMethod
      - AdminServiceGetUserMethod
      - AdminServiceUpdateUserMethod
      - AdminServiceDeleteUserMethod
      - AdminServiceGetConfigMethod
      - AdminServiceUpdateConfigMethod
      - AdminServiceGetConfigHistoryMethod
      - AdminServiceGetDashboardOverviewMethod
      - AdminServiceGetMetricsMethod
      - AdminServiceGetServicesMethod
      - AdminServiceGetErrorsMethod
      - AdminServiceQueryAuditLogsMethod
      - AdminServiceGetLogStreamsMethod
    Properties:
      RestApiId: !Ref AdminServiceApi
      Description: !Sub Admin Service API deployment for ${Environment} with all endpoints

  # Update Admin Service API Stage
  AdminServiceApiStageUpdate:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId: !Ref AdminServiceApi
      DeploymentId: !Ref AdminServiceApiDeploymentUpdate
      StageName: v1
      Description: !Sub Admin Service API stage for ${Environment}
      TracingEnabled: true
      MethodSettings:
        - ResourcePath: "/*"
          HttpMethod: "*"
          LoggingLevel: INFO
          DataTraceEnabled: !If [IsProduction, false, true]
          MetricsEnabled: true
          ThrottlingRateLimit: 10
          ThrottlingBurstLimit: 20

  # ==========================================
  # CloudWatch Monitoring
  # ==========================================
  AlarmTopic:
    Type: AWS::SNS::Topic
    Condition: HasAlarmEmail
    Properties:
      TopicName: !Sub bayon-coagent-alarms-${Environment}
      DisplayName: !Sub Bayon CoAgent Alarms (${Environment})
      Subscription:
        - Endpoint: !Ref AlarmEmail
          Protocol: email
        - Endpoint: !Ref AlarmEmail
          Protocol: email

  # ==========================================
  # Deployment Alarms for Automatic Rollback
  # ==========================================
  LambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${Environment}-lambda-deployment-errors
      AlarmDescription: Alert when Lambda function errors exceed threshold during deployment
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  LambdaThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${Environment}-lambda-deployment-throttles
      AlarmDescription: Alert when Lambda function throttles exceed threshold during deployment
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 2
      Threshold: 3
      ComparisonOperator: GreaterThanThreshold
      TreatMissingData: notBreaching

  # ==========================================
  # Traffic Hook Functions for Deployment Validation
  # ==========================================
  PreTrafficHookFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-pre-traffic-hook-${Environment}
      CodeUri: src/lambda/
      Handler: deployment-hooks/pre-traffic.handler
      Runtime: nodejs22.x
      Timeout: 60
      MemorySize: 256
      Role: !GetAtt ApplicationRole.Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Purpose: DeploymentValidation

  PostTrafficHookFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-post-traffic-hook-${Environment}
      CodeUri: src/lambda/
      Handler: deployment-hooks/post-traffic.handler
      Runtime: nodejs22.x
      Timeout: 60
      MemorySize: 256
      Role: !GetAtt ApplicationRole.Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Purpose: DeploymentValidation

  # ==========================================
  # Service-Specific Alarms
  # ==========================================
  AuthFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-high-auth-failures
      AlarmDescription: Alert when authentication failures exceed threshold
      MetricName: SignInThrottles
      Namespace: AWS/Cognito
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: UserPool
          Value: !Ref UserPool
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  DynamoDBThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-dynamodb-throttling
      AlarmDescription: Alert when DynamoDB requests are being throttled
      MetricName: UserErrors
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TableName
          Value: !Ref DynamoDBTable
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  S3ErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-s3-errors
      AlarmDescription: Alert when S3 5xx errors exceed threshold
      MetricName: 5xxErrors
      Namespace: AWS/S3
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: BucketName
          Value: !Ref StorageBucket
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  # Lambda Function Alarms
  LifeEventProcessorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-life-event-processor-errors
      AlarmDescription: Alert when life event processor has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref LifeEventProcessorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  CompetitorMonitorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-competitor-monitor-errors
      AlarmDescription: Alert when competitor monitor has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref CompetitorMonitorProcessorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  TrendDetectorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-trend-detector-errors
      AlarmDescription: Alert when trend detector has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref TrendDetectorProcessorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  PriceReductionProcessorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-price-reduction-processor-errors
      AlarmDescription: Alert when price reduction processor has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref PriceReductionProcessorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  NotificationProcessorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-notification-processor-errors
      AlarmDescription: Alert when notification processor has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref NotificationProcessorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  NotificationDigestGeneratorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-notification-digest-generator-errors
      AlarmDescription: Alert when notification digest generator has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref NotificationDigestGeneratorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  NotificationRetryProcessorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-notification-retry-processor-errors
      AlarmDescription: Alert when notification retry processor has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref NotificationRetryProcessorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  NotificationCleanupMaintenanceErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-notification-cleanup-maintenance-errors
      AlarmDescription: Alert when notification cleanup maintenance has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !GetAtt NotificationCleanupMaintenanceFunction.Arn
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  # Content Workflow Lambda Alarms
  CalculateOptimalTimesErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-calculate-optimal-times-errors
      AlarmDescription: Alert when calculate optimal times has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref CalculateOptimalTimesFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  PublishScheduledContentErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-publish-scheduled-content-errors
      AlarmDescription: Alert when publish scheduled content has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref PublishScheduledContentFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  SyncSocialAnalyticsErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-sync-social-analytics-errors
      AlarmDescription: Alert when sync social analytics has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref SyncSocialAnalyticsFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  # Enhanced Performance Monitoring Alarms for Content Workflow Functions
  PublishScheduledContentDurationAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-publish-scheduled-content-duration
      AlarmDescription: Alert when publish scheduled content duration exceeds threshold
      MetricName: Duration
      Namespace: AWS/Lambda
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 600000 # 10 minutes in milliseconds
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref PublishScheduledContentFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  PublishScheduledContentThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-publish-scheduled-content-throttles
      AlarmDescription: Alert when publish scheduled content is being throttled
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref PublishScheduledContentFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  SyncSocialAnalyticsDurationAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-sync-social-analytics-duration
      AlarmDescription: Alert when sync social analytics duration exceeds threshold
      MetricName: Duration
      Namespace: AWS/Lambda
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 720000 # 12 minutes in milliseconds
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref SyncSocialAnalyticsFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  SyncSocialAnalyticsThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-sync-social-analytics-throttles
      AlarmDescription: Alert when sync social analytics is being throttled
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref SyncSocialAnalyticsFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  CalculateOptimalTimesDurationAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-calculate-optimal-times-duration
      AlarmDescription: Alert when calculate optimal times duration exceeds threshold
      MetricName: Duration
      Namespace: AWS/Lambda
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 720000 # 12 minutes in milliseconds
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref CalculateOptimalTimesFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  CalculateOptimalTimesThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-calculate-optimal-times-throttles
      AlarmDescription: Alert when calculate optimal times is being throttled
      MetricName: Throttles
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref CalculateOptimalTimesFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  # Dead Letter Queue Alarms
  PublishScheduledContentDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-publish-scheduled-content-dlq-messages
      AlarmDescription: Alert when messages appear in publish scheduled content DLQ
      MetricName: ApproximateNumberOfVisibleMessages
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt PublishScheduledContentDLQ.QueueName
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  SyncSocialAnalyticsDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-sync-social-analytics-dlq-messages
      AlarmDescription: Alert when messages appear in sync social analytics DLQ
      MetricName: ApproximateNumberOfVisibleMessages
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt SyncSocialAnalyticsDLQ.QueueName
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  CalculateOptimalTimesDLQAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-calculate-optimal-times-dlq-messages
      AlarmDescription: Alert when messages appear in calculate optimal times DLQ
      MetricName: ApproximateNumberOfVisibleMessages
      Namespace: AWS/SQS
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: QueueName
          Value: !GetAtt CalculateOptimalTimesDLQ.QueueName
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  # Content Workflow Business Metrics Alarms
  ContentWorkflowPublishingFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-content-workflow-publishing-failures
      AlarmDescription: Alert when content publishing failure rate exceeds threshold
      MetricName: PublishingFailure
      Namespace: BayonCoAgent/ContentWorkflow
      Statistic: Sum
      Period: 900 # 15 minutes
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  ContentWorkflowAnalyticsSyncFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-content-workflow-analytics-sync-failures
      AlarmDescription: Alert when analytics sync failure rate exceeds threshold
      MetricName: AnalyticsSyncFailure
      Namespace: BayonCoAgent/ContentWorkflow
      Statistic: Sum
      Period: 3600 # 1 hour
      EvaluationPeriods: 2
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  ContentWorkflowRateLimitAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-content-workflow-rate-limits
      AlarmDescription: Alert when rate limiting occurs frequently
      MetricName: RateLimitEncountered
      Namespace: BayonCoAgent/ContentWorkflow
      Statistic: Sum
      Period: 3600 # 1 hour
      EvaluationPeriods: 1
      Threshold: 20
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  # ==========================================
  # CloudWatch Dashboard
  # ==========================================
  MonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub BayonCoAgent-${Environment}
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Cognito", "SignInSuccesses", {"stat": "Sum"}],
                  [".", "SignInThrottles", {"stat": "Sum"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Authentication Activity",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", {"stat": "Sum"}],
                  [".", "ConsumedWriteCapacityUnits", {"stat": "Sum"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "DynamoDB Activity",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/S3", "AllRequests", {"stat": "Sum"}],
                  [".", "4xxErrors", {"stat": "Sum"}],
                  [".", "5xxErrors", {"stat": "Sum"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "S3 Activity",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Bedrock", "Invocations", {"stat": "Sum"}],
                  [".", "ModelInvocationThrottles", {"stat": "Sum"}],
                  [".", "InvocationLatency", {"stat": "Average"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Bedrock Activity",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${LifeEventProcessorFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Life Event Processor",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${CompetitorMonitorProcessorFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Competitor Monitor",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${TrendDetectorProcessorFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Trend Detector",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${PriceReductionProcessorFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Price Reduction Monitor",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${NotificationProcessorFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Notification Processor",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${CalculateOptimalTimesFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Calculate Optimal Times",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${PublishScheduledContentFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Publish Scheduled Content",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${SyncSocialAnalyticsFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}],
                  [".", "Throttles", ".", ".", {"stat": "Sum"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Sync Social Analytics",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/SQS", "ApproximateNumberOfVisibleMessages", "QueueName", "${PublishScheduledContentDLQ.QueueName}", {"stat": "Sum"}],
                  [".", ".", ".", "${SyncSocialAnalyticsDLQ.QueueName}", {"stat": "Sum"}],
                  [".", ".", ".", "${CalculateOptimalTimesDLQ.QueueName}", {"stat": "Sum"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Content Workflow Dead Letter Queues",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["BayonCoAgent/ContentWorkflow", "PublishingSuccess", {"stat": "Sum"}],
                  [".", "PublishingFailure", {"stat": "Sum"}],
                  [".", "AnalyticsSyncSuccess", {"stat": "Sum"}],
                  [".", "AnalyticsSyncFailure", {"stat": "Sum"}],
                  [".", "OptimalTimesCalculated", {"stat": "Sum"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Content Workflow Business Metrics",
                "yAxis": {"left": {"min": 0}}
              }
            }
          ]
        }

Outputs:
  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
    Export:
      Name: !Sub ${Environment}-UserPoolId

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub ${Environment}-UserPoolClientId

  IdentityPoolId:
    Description: Cognito Identity Pool ID
    Value: !Ref IdentityPool
    Export:
      Name: !Sub ${Environment}-IdentityPoolId

  DynamoDBTableName:
    Description: DynamoDB Table Name
    Value: !Ref DynamoDBTable
    Export:
      Name: !Sub ${Environment}-DynamoDBTableName

  DynamoDBTableArn:
    Description: DynamoDB Table ARN
    Value: !GetAtt DynamoDBTable.Arn
    Export:
      Name: !Sub ${Environment}-DynamoDBTableArn

  StorageBucketName:
    Description: S3 Storage Bucket Name
    Value: !Ref StorageBucket
    Export:
      Name: !Sub ${Environment}-StorageBucketName

  StorageBucketArn:
    Description: S3 Storage Bucket ARN
    Value: !GetAtt StorageBucket.Arn
    Export:
      Name: !Sub ${Environment}-StorageBucketArn

  ApplicationRoleArn:
    Description: Application Role ARN
    Value: !GetAtt ApplicationRole.Arn
    Export:
      Name: !Sub ${Environment}-ApplicationRoleArn

  DashboardURL:
    Description: CloudWatch Dashboard URL
    Value: !Sub https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${MonitoringDashboard}

  Region:
    Description: AWS Region
    Value: !Ref AWS::Region
    Export:
      Name: !Sub ${Environment}-Region

  # Lambda Function Outputs
  LifeEventProcessorFunctionArn:
    Description: Life Event Processor Lambda Function ARN
    Value: !GetAtt LifeEventProcessorFunction.Arn
    Export:
      Name: !Sub ${Environment}-LifeEventProcessorFunctionArn

  CompetitorMonitorProcessorFunctionArn:
    Description: Competitor Monitor Processor Lambda Function ARN
    Value: !GetAtt CompetitorMonitorProcessorFunction.Arn
    Export:
      Name: !Sub ${Environment}-CompetitorMonitorProcessorFunctionArn

  TrendDetectorProcessorFunctionArn:
    Description: Trend Detector Processor Lambda Function ARN
    Value: !GetAtt TrendDetectorProcessorFunction.Arn
    Export:
      Name: !Sub ${Environment}-TrendDetectorProcessorFunctionArn

  PriceReductionProcessorFunctionArn:
    Description: Price Reduction Processor Lambda Function ARN
    Value: !GetAtt PriceReductionProcessorFunction.Arn
    Export:
      Name: !Sub ${Environment}-PriceReductionProcessorFunctionArn

  NotificationProcessorFunctionArn:
    Description: Notification Processor Lambda Function ARN
    Value: !GetAtt NotificationProcessorFunction.Arn
    Export:
      Name: !Sub ${Environment}-NotificationProcessorFunctionArn

  NotificationDigestGeneratorFunctionArn:
    Description: Notification Digest Generator Lambda Function ARN
    Value: !GetAtt NotificationDigestGeneratorFunction.Arn
    Export:
      Name: !Sub ${Environment}-NotificationDigestGeneratorFunctionArn

  NotificationRetryProcessorFunctionArn:
    Description: Notification Retry Processor Lambda Function ARN
    Value: !GetAtt NotificationRetryProcessorFunction.Arn
    Export:
      Name: !Sub ${Environment}-NotificationRetryProcessorFunctionArn

  NotificationCleanupMaintenanceFunctionArn:
    Description: Notification Cleanup Maintenance Lambda Function ARN
    Value: !GetAtt NotificationCleanupMaintenanceFunction.Arn
    Export:
      Name: !Sub ${Environment}-NotificationCleanupMaintenanceFunctionArn

  # Content Workflow Lambda Function Outputs
  CalculateOptimalTimesFunctionArn:
    Description: Calculate Optimal Times Lambda Function ARN
    Value: !GetAtt CalculateOptimalTimesFunction.Arn
    Export:
      Name: !Sub ${Environment}-CalculateOptimalTimesFunctionArn

  PublishScheduledContentFunctionArn:
    Description: Publish Scheduled Content Lambda Function ARN
    Value: !GetAtt PublishScheduledContentFunction.Arn
    Export:
      Name: !Sub ${Environment}-PublishScheduledContentFunctionArn

  SyncSocialAnalyticsFunctionArn:
    Description: Sync Social Analytics Lambda Function ARN
    Value: !GetAtt SyncSocialAnalyticsFunction.Arn
    Export:
      Name: !Sub ${Environment}-SyncSocialAnalyticsFunctionArn

  # Content Workflow Dead Letter Queue Outputs
  PublishScheduledContentDLQArn:
    Description: Publish Scheduled Content Dead Letter Queue ARN
    Value: !GetAtt PublishScheduledContentDLQ.Arn
    Export:
      Name: !Sub ${Environment}-PublishScheduledContentDLQArn

  SyncSocialAnalyticsDLQArn:
    Description: Sync Social Analytics Dead Letter Queue ARN
    Value: !GetAtt SyncSocialAnalyticsDLQ.Arn
    Export:
      Name: !Sub ${Environment}-SyncSocialAnalyticsDLQArn

  CalculateOptimalTimesDLQArn:
    Description: Calculate Optimal Times Dead Letter Queue ARN
    Value: !GetAtt CalculateOptimalTimesDLQ.Arn
    Export:
      Name: !Sub ${Environment}-CalculateOptimalTimesDLQArn

  ContentWorkflowLambdaRoleArn:
    Description: Content Workflow Lambda Role ARN
    Value: !GetAtt ContentWorkflowLambdaRole.Arn
    Export:
      Name: !Sub ${Environment}-ContentWorkflowLambdaRoleArn

  # API Gateway Outputs
  MainRestApiId:
    Description: Main REST API ID
    Value: !Ref MainRestApi
    Export:
      Name: !Sub ${Environment}-MainRestApiId

  MainRestApiUrl:
    Description: Main REST API URL
    Value: !Sub https://${MainRestApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}
    Export:
      Name: !Sub ${Environment}-MainRestApiUrl

  AiServiceApiId:
    Description: AI Service API ID
    Value: !Ref AiServiceApi
    Export:
      Name: !Sub ${Environment}-AiServiceApiId

  AiServiceApiUrl:
    Description: AI Service API URL
    Value: !Sub https://${AiServiceApi}.execute-api.${AWS::Region}.amazonaws.com/v1
    Export:
      Name: !Sub ${Environment}-AiServiceApiUrl

  IntegrationServiceApiId:
    Description: Integration Service API ID
    Value: !Ref IntegrationServiceApi
    Export:
      Name: !Sub ${Environment}-IntegrationServiceApiId

  IntegrationServiceApiUrl:
    Description: Integration Service API URL
    Value: !Sub https://${IntegrationServiceApi}.execute-api.${AWS::Region}.amazonaws.com/v1
    Export:
      Name: !Sub ${Environment}-IntegrationServiceApiUrl

  BackgroundServiceApiId:
    Description: Background Service API ID
    Value: !Ref BackgroundServiceApi
    Export:
      Name: !Sub ${Environment}-BackgroundServiceApiId

  BackgroundServiceApiUrl:
    Description: Background Service API URL
    Value: !Sub https://${BackgroundServiceApi}.execute-api.${AWS::Region}.amazonaws.com/v1
    Export:
      Name: !Sub ${Environment}-BackgroundServiceApiUrl

  AdminServiceApiId:
    Description: Admin Service API ID
    Value: !Ref AdminServiceApi
    Export:
      Name: !Sub ${Environment}-AdminServiceApiId

  AdminServiceApiUrl:
    Description: Admin Service API URL
    Value: !Sub https://${AdminServiceApi}.execute-api.${AWS::Region}.amazonaws.com/v1
    Export:
      Name: !Sub ${Environment}-AdminServiceApiUrl

  # Secrets Manager Outputs
  GoogleOAuthSecretArn:
    Description: Google OAuth Secret ARN
    Value: !Ref GoogleOAuthSecret
    Export:
      Name: !Sub ${Environment}-GoogleOAuthSecretArn

  FacebookOAuthSecretArn:
    Description: Facebook OAuth Secret ARN
    Value: !Ref FacebookOAuthSecret
    Export:
      Name: !Sub ${Environment}-FacebookOAuthSecretArn

  InstagramOAuthSecretArn:
    Description: Instagram OAuth Secret ARN
    Value: !Ref InstagramOAuthSecret
    Export:
      Name: !Sub ${Environment}-InstagramOAuthSecretArn

  LinkedInOAuthSecretArn:
    Description: LinkedIn OAuth Secret ARN
    Value: !Ref LinkedInOAuthSecret
    Export:
      Name: !Sub ${Environment}-LinkedInOAuthSecretArn

  TwitterOAuthSecretArn:
    Description: Twitter OAuth Secret ARN
    Value: !Ref TwitterOAuthSecret
    Export:
      Name: !Sub ${Environment}-TwitterOAuthSecretArn

  MLSAPISecretArn:
    Description: MLS API Secret ARN
    Value: !Ref MLSAPISecret
    Export:
      Name: !Sub ${Environment}-MLSAPISecretArn

  AiJobRequestQueueUrl:
    Description: AI Job Request Queue URL
    Value: !Ref AiJobRequestQueue
    Export:
      Name: !Sub ${Environment}-AiJobRequestQueueUrl

  AiJobRequestQueueArn:
    Description: AI Job Request Queue ARN
    Value: !GetAtt AiJobRequestQueue.Arn
    Export:
      Name: !Sub ${Environment}-AiJobRequestQueueArn

  AiJobResponseQueueUrl:
    Description: AI Job Response Queue URL
    Value: !Ref AiJobResponseQueue
    Export:
      Name: !Sub ${Environment}-AiJobResponseQueueUrl

  AiJobResponseQueueArn:
    Description: AI Job Response Queue ARN
    Value: !GetAtt AiJobResponseQueue.Arn
    Export:
      Name: !Sub ${Environment}-AiJobResponseQueueArn

  # EventBridge Outputs
  ApplicationEventBusName:
    Description: Application Event Bus Name
    Value: !Ref ApplicationEventBus
    Export:
      Name: !Sub ${Environment}-ApplicationEventBusName

  ApplicationEventBusArn:
    Description: Application Event Bus ARN
    Value: !GetAtt ApplicationEventBus.Arn
    Export:
      Name: !Sub ${Environment}-ApplicationEventBusArn

  EventSchemaRegistryName:
    Description: Event Schema Registry Name
    Value: !Ref EventSchemaRegistry
    Export:
      Name: !Sub ${Environment}-EventSchemaRegistryName

  EventBridgeDLQUrl:
    Description: EventBridge Dead Letter Queue URL
    Value: !Ref EventBridgeDLQ
    Export:
      Name: !Sub ${Environment}-EventBridgeDLQUrl

  EventBridgeDLQArn:
    Description: EventBridge Dead Letter Queue ARN
    Value: !GetAtt EventBridgeDLQ.Arn
    Export:
      Name: !Sub ${Environment}-EventBridgeDLQArn

  # Stripe Integration Outputs
  StripeSubscriptionHandlerFunctionArn:
    Description: Stripe Subscription Handler Lambda Function ARN
    Value: !GetAtt StripeSubscriptionHandlerFunction.Arn
    Export:
      Name: !Sub ${AWS::StackName}-StripeSubscriptionHandlerFunctionArn

  StripeEventDLQUrl:
    Description: Stripe Event Dead Letter Queue URL
    Value: !Ref StripeEventDLQ
    Export:
      Name: !Sub ${AWS::StackName}-StripeEventDLQUrl

  StripeSecretArn:
    Description: Stripe Secret ARN in Secrets Manager
    Value: !Ref StripeSecret
    Export:
      Name: !Sub ${AWS::StackName}-StripeSecretArn
