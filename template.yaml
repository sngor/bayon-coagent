AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: Bayon CoAgent - Serverless Infrastructure

Parameters:
  Environment:
    Type: String
    Default: development
    AllowedValues:
      - development
      - production
    Description: Environment name

  AlarmEmail:
    Type: String
    Default: ""
    Description: Email address for CloudWatch alarms (optional)

Conditions:
  IsProduction: !Equals [!Ref Environment, production]
  HasAlarmEmail: !Not [!Equals [!Ref AlarmEmail, ""]]

Globals:
  Function:
    Timeout: 30
    MemorySize: 1024
    Runtime: nodejs18.x
    Environment:
      Variables:
        NODE_ENV: !Ref Environment
        AWS_REGION: !Ref AWS::Region
        COGNITO_USER_POOL_ID: !Ref UserPool
        COGNITO_CLIENT_ID: !Ref UserPoolClient
        DYNAMODB_TABLE_NAME: !Ref DynamoDBTable
        S3_BUCKET_NAME: !Ref StorageBucket
        BEDROCK_MODEL_ID: anthropic.claude-3-5-sonnet-20241022-v2:0
        BEDROCK_REGION: !Ref AWS::Region

Resources:
  # ==========================================
  # Cognito User Pool
  # ==========================================
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName: !Sub bayon-coagent-${Environment}
      AutoVerifiedAttributes:
        - email
      UsernameAttributes:
        - email
      Schema:
        - Name: email
          Required: true
          Mutable: true
        - Name: given_name
          Required: false
          Mutable: true
        - Name: family_name
          Required: false
          Mutable: true
        - Name: agentId
          AttributeDataType: String
          Mutable: true
        - Name: businessName
          AttributeDataType: String
          Mutable: true
      Policies:
        PasswordPolicy:
          MinimumLength: 8
          RequireLowercase: true
          RequireUppercase: true
          RequireNumbers: true
          RequireSymbols: true
          TemporaryPasswordValidityDays: 7
      MfaConfiguration: "OFF"
      AccountRecoverySetting:
        RecoveryMechanisms:
          - Name: verified_email
            Priority: 1
      UserAttributeUpdateSettings:
        AttributesRequireVerificationBeforeUpdate:
          - email
      EmailConfiguration:
        EmailSendingAccount: COGNITO_DEFAULT
      UserPoolTags:
        Environment: !Ref Environment
        Application: BayonCoAgent

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: !Sub bayon-coagent-web-${Environment}
      UserPoolId: !Ref UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
        - ALLOW_USER_PASSWORD_AUTH
        - ALLOW_USER_SRP_AUTH
        - ALLOW_REFRESH_TOKEN_AUTH
        - ALLOW_CUSTOM_AUTH
      PreventUserExistenceErrors: ENABLED
      RefreshTokenValidity: 30
      AccessTokenValidity: 60
      IdTokenValidity: 60
      TokenValidityUnits:
        RefreshToken: days
        AccessToken: minutes
        IdToken: minutes
      EnableTokenRevocation: true
      AllowedOAuthFlows:
        - code
      AllowedOAuthScopes:
        - email
        - openid
        - profile
      AllowedOAuthFlowsUserPoolClient: true
      CallbackURLs:
        - !If
          - IsProduction
          - https://yourdomain.com/oauth/callback
          - http://localhost:3000/oauth/callback
      LogoutURLs:
        - !If
          - IsProduction
          - https://yourdomain.com
          - http://localhost:3000

  IdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !Sub bayon_coagent_${Environment}
      AllowUnauthenticatedIdentities: false
      CognitoIdentityProviders:
        - ClientId: !Ref UserPoolClient
          ProviderName: !GetAtt UserPool.ProviderName

  IdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref IdentityPool
      Roles:
        authenticated: !GetAtt AuthenticatedRole.Arn

  AuthenticatedRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: cognito-identity.amazonaws.com
            Action: sts:AssumeRoleWithWebIdentity
            Condition:
              StringEquals:
                cognito-identity.amazonaws.com:aud: !Ref IdentityPool
              ForAnyValue:StringLike:
                cognito-identity.amazonaws.com:amr: authenticated
      Policies:
        - PolicyName: UserScopedAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                Resource: !GetAtt DynamoDBTable.Arn
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource: !Sub ${StorageBucket.Arn}/*
              - Effect: Allow
                Action: s3:ListBucket
                Resource: !GetAtt StorageBucket.Arn

  # ==========================================
  # DynamoDB Table
  # ==========================================
  DynamoDBTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub BayonCoAgent-${Environment}
      BillingMode: PAY_PER_REQUEST
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: !If [IsProduction, true, false]
      SSESpecification:
        SSEEnabled: true
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
        - AttributeName: GSI1PK
          AttributeType: S
        - AttributeName: GSI1SK
          AttributeType: S
        - AttributeName: EntityType
          AttributeType: S
        - AttributeName: CreatedAt
          AttributeType: N
        - AttributeName: UserId
          AttributeType: S
        - AttributeName: UpdatedAt
          AttributeType: N
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: GSI1
          KeySchema:
            - AttributeName: GSI1PK
              KeyType: HASH
            - AttributeName: GSI1SK
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: EntityTypeIndex
          KeySchema:
            - AttributeName: EntityType
              KeyType: HASH
            - AttributeName: CreatedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: UserIndex
          KeySchema:
            - AttributeName: UserId
              KeyType: HASH
            - AttributeName: UpdatedAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent

  # ==========================================
  # S3 Storage Bucket
  # ==========================================
  StorageBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub bayon-coagent-storage-${Environment}-${AWS::AccountId}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: !If [IsProduction, Enabled, Suspended]
      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpirationInDays: 90
          - Id: TransitionToIA
            Status: !If [IsProduction, Enabled, Disabled]
            Transitions:
              - TransitionInDays: 90
                StorageClass: STANDARD_IA
          - Id: ArchiveOldReimagineEdits
            Status: !If [IsProduction, Enabled, Disabled]
            Prefix: reimagine/edits/
            Transitions:
              - TransitionInDays: 90
                StorageClass: STANDARD_IA
              - TransitionInDays: 180
                StorageClass: GLACIER
          - Id: DeleteReimaginePreviewEdits
            Status: Enabled
            Prefix: reimagine/preview/
            ExpirationInDays: 7
      CorsConfiguration:
        CorsRules:
          - AllowedOrigins:
              - !If
                - IsProduction
                - https://yourdomain.com
                - http://localhost:3000
            AllowedMethods:
              - GET
              - PUT
              - POST
              - DELETE
              - HEAD
            AllowedHeaders:
              - "*"
            ExposedHeaders:
              - ETag
              - x-amz-server-side-encryption
              - x-amz-request-id
              - x-amz-id-2
              - Content-Type
              - Content-Length
            MaxAge: 3000
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: BayonCoAgent

  StorageBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref StorageBucket
      PolicyDocument:
        Statement:
          - Sid: AllowApplicationAccess
            Effect: Allow
            Principal:
              AWS: !GetAtt ApplicationRole.Arn
            Action:
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
              - s3:ListBucket
            Resource:
              - !GetAtt StorageBucket.Arn
              - !Sub ${StorageBucket.Arn}/*

  # ==========================================
  # IAM Roles
  # ==========================================
  ApplicationRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub bayon-coagent-app-${Environment}
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
                - ecs-tasks.amazonaws.com
                - amplify.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CognitoAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:AdminGetUser
                  - cognito-idp:AdminCreateUser
                  - cognito-idp:AdminUpdateUserAttributes
                  - cognito-idp:AdminDeleteUser
                  - cognito-idp:ListUsers
                Resource: !GetAtt UserPool.Arn
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                  - dynamodb:Scan
                  - dynamodb:BatchGetItem
                  - dynamodb:BatchWriteItem
                  - dynamodb:DescribeStream
                  - dynamodb:GetRecords
                  - dynamodb:GetShardIterator
                  - dynamodb:ListStreams
                Resource:
                  - !GetAtt DynamoDBTable.Arn
                  - !Sub ${DynamoDBTable.Arn}/index/*
                  - !Sub ${DynamoDBTable.Arn}/stream/*
        - PolicyName: S3Access
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                  - s3:ListBucket
                Resource:
                  - !GetAtt StorageBucket.Arn
                  - !Sub ${StorageBucket.Arn}/*
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogStreams
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/bayon-coagent/*
        - PolicyName: BedrockAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:ListFoundationModels
                  - bedrock:GetFoundationModel
                Resource:
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/anthropic.claude-*
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-image-generator-v1
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/amazon.titan-*
                  - !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/stability.stable-diffusion-xl-v1

  # ==========================================
  # Alert Processing Lambda Functions
  # ==========================================

  # Life Event Analysis Lambda (Daily)
  LifeEventProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-life-event-processor-${Environment}
      CodeUri: src/lambda/
      Handler: life-event-processor.handler
      Runtime: nodejs18.x
      Timeout: 900 # 15 minutes
      MemorySize: 2048
      Role: !GetAtt ApplicationRole.Arn
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 6 * * ? *) # Daily at 6 AM UTC
            Description: Daily life event analysis
            Enabled: true
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: LifeEventProcessor

  # Competitor Monitoring Lambda (Every 4 hours)
  CompetitorMonitorProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-competitor-monitor-${Environment}
      CodeUri: src/lambda/
      Handler: competitor-monitor-processor.handler
      Runtime: nodejs18.x
      Timeout: 900 # 15 minutes
      MemorySize: 2048
      Role: !GetAtt ApplicationRole.Arn
      Events:
        FourHourlySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 */4 * * ? *) # Every 4 hours
            Description: Competitor monitoring every 4 hours
            Enabled: true
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: CompetitorMonitor

  # Neighborhood Trend Detection Lambda (Daily)
  TrendDetectorProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-trend-detector-${Environment}
      CodeUri: src/lambda/
      Handler: trend-detector-processor.handler
      Runtime: nodejs18.x
      Timeout: 900 # 15 minutes
      MemorySize: 2048
      Role: !GetAtt ApplicationRole.Arn
      Events:
        DailySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 7 * * ? *) # Daily at 7 AM UTC (1 hour after life events)
            Description: Daily neighborhood trend analysis
            Enabled: true
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: TrendDetector

  # Price Reduction Monitoring Lambda (Every 4 hours)
  PriceReductionProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-price-reduction-monitor-${Environment}
      CodeUri: src/lambda/
      Handler: price-reduction-processor.handler
      Runtime: nodejs18.x
      Timeout: 900 # 15 minutes
      MemorySize: 2048
      Role: !GetAtt ApplicationRole.Arn
      Events:
        FourHourlySchedule:
          Type: Schedule
          Properties:
            Schedule: cron(30 */4 * * ? *) # Every 4 hours, offset by 30 minutes from competitor monitoring
            Description: Price reduction monitoring every 4 hours
            Enabled: true
      Environment:
        Variables:
          LOG_LEVEL: INFO
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Function: PriceReductionMonitor

  # Notification Processing Lambda (Every 15 minutes for queue processing, scheduled for digests)
  NotificationProcessorFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-notification-processor-${Environment}
      CodeUri: src/lambda/
      Handler: notification-processor.handler
      Timeout: 300
      MemorySize: 512
      Environment:
        Variables:
          SES_FROM_EMAIL: !Sub noreply@bayoncoagent.com
          SES_REGION: !Ref AWS::Region
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DynamoDBTable
        - SESCrudPolicy:
            IdentityName: "*"
        - Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action:
                - ses:SendEmail
                - ses:SendBulkTemplatedEmail
                - ses:CreateTemplate
                - ses:UpdateTemplate
                - ses:GetTemplate
                - ses:ListTemplates
              Resource: "*"
      Events:
        # Process notification queue every 15 minutes
        QueueProcessingSchedule:
          Type: Schedule
          Properties:
            Schedule: rate(15 minutes)
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "type": "process-queue"
                }
              }
        # Daily digest at 9 AM UTC (adjust as needed)
        DailyDigestSchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 9 * * ? *)
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "type": "daily-digest"
                }
              }
        # Weekly digest on Mondays at 9 AM UTC
        WeeklyDigestSchedule:
          Type: Schedule
          Properties:
            Schedule: cron(0 9 ? * MON *)
            Input: !Sub |
              {
                "source": "aws.events",
                "detail-type": "Scheduled Event",
                "detail": {
                  "type": "weekly-digest"
                }
              }
      DeadLetterQueue:
        Type: SQS
        TargetArn: !GetAtt NotificationProcessorDLQ.Arn

  # Dead Letter Queue for notification processor
  NotificationProcessorDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub bayon-coagent-notification-processor-dlq-${Environment}
      MessageRetentionPeriod: 1209600 # 14 days

  # ==========================================
  # CloudWatch Monitoring
  # ==========================================
  AlarmTopic:
    Type: AWS::SNS::Topic
    Condition: HasAlarmEmail
    Properties:
      TopicName: !Sub bayon-coagent-alarms-${Environment}
      DisplayName: !Sub Bayon CoAgent Alarms (${Environment})
      Subscription:
        - Endpoint: !Ref AlarmEmail
          Protocol: email

  AuthFailureAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-high-auth-failures
      AlarmDescription: Alert when authentication failures exceed threshold
      MetricName: SignInThrottles
      Namespace: AWS/Cognito
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: UserPool
          Value: !Ref UserPool
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  DynamoDBThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-dynamodb-throttling
      AlarmDescription: Alert when DynamoDB requests are being throttled
      MetricName: UserErrors
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TableName
          Value: !Ref DynamoDBTable
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  S3ErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-s3-errors
      AlarmDescription: Alert when S3 5xx errors exceed threshold
      MetricName: 5xxErrors
      Namespace: AWS/S3
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: BucketName
          Value: !Ref StorageBucket
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  # Lambda Function Alarms
  LifeEventProcessorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-life-event-processor-errors
      AlarmDescription: Alert when life event processor has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref LifeEventProcessorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  CompetitorMonitorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-competitor-monitor-errors
      AlarmDescription: Alert when competitor monitor has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref CompetitorMonitorProcessorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  TrendDetectorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-trend-detector-errors
      AlarmDescription: Alert when trend detector has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref TrendDetectorProcessorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  PriceReductionProcessorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-price-reduction-processor-errors
      AlarmDescription: Alert when price reduction processor has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref PriceReductionProcessorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  NotificationProcessorErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: HasAlarmEmail
    Properties:
      AlarmName: !Sub ${Environment}-notification-processor-errors
      AlarmDescription: Alert when notification processor has errors
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref NotificationProcessorFunction
      AlarmActions:
        - !Ref AlarmTopic
      TreatMissingData: notBreaching

  # ==========================================
  # CloudWatch Dashboard
  # ==========================================
  MonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardName: !Sub BayonCoAgent-${Environment}
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Cognito", "SignInSuccesses", {"stat": "Sum"}],
                  [".", "SignInThrottles", {"stat": "Sum"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Authentication Activity",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", {"stat": "Sum"}],
                  [".", "ConsumedWriteCapacityUnits", {"stat": "Sum"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "DynamoDB Activity",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/S3", "AllRequests", {"stat": "Sum"}],
                  [".", "4xxErrors", {"stat": "Sum"}],
                  [".", "5xxErrors", {"stat": "Sum"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "S3 Activity",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Bedrock", "Invocations", {"stat": "Sum"}],
                  [".", "ModelInvocationThrottles", {"stat": "Sum"}],
                  [".", "InvocationLatency", {"stat": "Average"}]
                ],
                "period": 300,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Bedrock Activity",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${LifeEventProcessorFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Life Event Processor",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${CompetitorMonitorProcessorFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Competitor Monitor",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${TrendDetectorProcessorFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Trend Detector",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${PriceReductionProcessorFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Price Reduction Monitor",
                "yAxis": {"left": {"min": 0}}
              }
            },
            {
              "type": "metric",
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${NotificationProcessorFunction}", {"stat": "Sum"}],
                  [".", "Errors", ".", ".", {"stat": "Sum"}],
                  [".", "Duration", ".", ".", {"stat": "Average"}]
                ],
                "period": 3600,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Notification Processor",
                "yAxis": {"left": {"min": 0}}
              }
            }
          ]
        }

Outputs:
  UserPoolId:
    Description: Cognito User Pool ID
    Value: !Ref UserPool
    Export:
      Name: !Sub ${Environment}-UserPoolId

  UserPoolClientId:
    Description: Cognito User Pool Client ID
    Value: !Ref UserPoolClient
    Export:
      Name: !Sub ${Environment}-UserPoolClientId

  IdentityPoolId:
    Description: Cognito Identity Pool ID
    Value: !Ref IdentityPool
    Export:
      Name: !Sub ${Environment}-IdentityPoolId

  DynamoDBTableName:
    Description: DynamoDB Table Name
    Value: !Ref DynamoDBTable
    Export:
      Name: !Sub ${Environment}-DynamoDBTableName

  DynamoDBTableArn:
    Description: DynamoDB Table ARN
    Value: !GetAtt DynamoDBTable.Arn
    Export:
      Name: !Sub ${Environment}-DynamoDBTableArn

  StorageBucketName:
    Description: S3 Storage Bucket Name
    Value: !Ref StorageBucket
    Export:
      Name: !Sub ${Environment}-StorageBucketName

  StorageBucketArn:
    Description: S3 Storage Bucket ARN
    Value: !GetAtt StorageBucket.Arn
    Export:
      Name: !Sub ${Environment}-StorageBucketArn

  ApplicationRoleArn:
    Description: Application Role ARN
    Value: !GetAtt ApplicationRole.Arn
    Export:
      Name: !Sub ${Environment}-ApplicationRoleArn

  DashboardURL:
    Description: CloudWatch Dashboard URL
    Value: !Sub https://console.aws.amazon.com/cloudwatch/home?region=${AWS::Region}#dashboards:name=${MonitoringDashboard}

  Region:
    Description: AWS Region
    Value: !Ref AWS::Region
    Export:
      Name: !Sub ${Environment}-Region

  # Lambda Function Outputs
  LifeEventProcessorFunctionArn:
    Description: Life Event Processor Lambda Function ARN
    Value: !GetAtt LifeEventProcessorFunction.Arn
    Export:
      Name: !Sub ${Environment}-LifeEventProcessorFunctionArn

  CompetitorMonitorProcessorFunctionArn:
    Description: Competitor Monitor Processor Lambda Function ARN
    Value: !GetAtt CompetitorMonitorProcessorFunction.Arn
    Export:
      Name: !Sub ${Environment}-CompetitorMonitorProcessorFunctionArn

  TrendDetectorProcessorFunctionArn:
    Description: Trend Detector Processor Lambda Function ARN
    Value: !GetAtt TrendDetectorProcessorFunction.Arn
    Export:
      Name: !Sub ${Environment}-TrendDetectorProcessorFunctionArn

  PriceReductionProcessorFunctionArn:
    Description: Price Reduction Processor Lambda Function ARN
    Value: !GetAtt PriceReductionProcessorFunction.Arn
    Export:
      Name: !Sub ${Environment}-PriceReductionProcessorFunctionArn

  NotificationProcessorFunctionArn:
    Description: Notification Processor Lambda Function ARN
    Value: !GetAtt NotificationProcessorFunction.Arn
    Export:
      Name: !Sub ${Environment}-NotificationProcessorFunctionArn
