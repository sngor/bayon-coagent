name: Monitoring & Maintenance

on:
    schedule:
        # Daily at 2 AM UTC
        - cron: "0 2 * * *"
    workflow_dispatch:
        inputs:
            check-type:
                description: "Type of check to run"
                type: choice
                options: [all, security, performance, costs, dependencies]
                default: all

jobs:
    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest
        if: inputs.check-type == 'security' || inputs.check-type == 'all' || github.event_name == 'schedule'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run npm audit
              run: |
                  npm audit --audit-level=high --json > audit-results.json || true
                  HIGH_VULNS=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
                  CRITICAL_VULNS=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)

                  if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
                    echo "::error::Found $CRITICAL_VULNS critical and $HIGH_VULNS high vulnerabilities"
                    exit 1
                  fi

            - name: Scan for secrets
              run: |
                  if git log --since="24 hours ago" -p | grep -E "AKIA[0-9A-Z]{16}" > /dev/null; then
                    echo "::error::AWS access keys detected in recent commits!"
                    exit 1
                  fi

    performance-check:
        name: Performance Check
        runs-on: ubuntu-latest
        if: inputs.check-type == 'performance' || inputs.check-type == 'all' || github.event_name == 'schedule'
        strategy:
            matrix:
                environment: [staging, production]
        steps:
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install Lighthouse
              run: npm install -g lighthouse

            - name: Run Lighthouse audit
              run: |
                  case "${{ matrix.environment }}" in
                    staging) URL="https://staging.bayoncoagent.com" ;;
                    production) URL="https://bayoncoagent.com" ;;
                  esac

                  lighthouse $URL \
                    --output=json \
                    --output-path=lighthouse-${{ matrix.environment }}.json \
                    --chrome-flags="--headless --no-sandbox"

                  PERFORMANCE=$(jq '.categories.performance.score * 100' lighthouse-${{ matrix.environment }}.json)
                  echo "Performance score for ${{ matrix.environment }}: $PERFORMANCE"

                  if (( $(echo "$PERFORMANCE < 90" | bc -l) )); then
                    echo "::warning::Performance score below threshold: $PERFORMANCE"
                  fi

            - name: Upload results
              uses: actions/upload-artifact@v4
              with:
                  name: lighthouse-${{ matrix.environment }}
                  path: lighthouse-${{ matrix.environment }}.json
                  retention-days: 30

    cost-monitoring:
        name: Cost Monitoring
        runs-on: ubuntu-latest
        if: inputs.check-type == 'costs' || inputs.check-type == 'all' || github.event_name == 'schedule'
        steps:
            - name: Check GitHub Actions usage
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  SINCE_DATE=$(date -u -d '30 days ago' +%Y-%m-%dT%H:%M:%SZ)

                  gh api \
                    -H "Accept: application/vnd.github+json" \
                    "/repos/${{ github.repository }}/actions/runs?created=>=$SINCE_DATE&per_page=100" \
                    > workflow_runs.json

                  TOTAL_MINUTES=$(jq '[.workflow_runs[] | 
                    select(.conclusion != null) | 
                    (((.updated_at | fromdateiso8601) - (.created_at | fromdateiso8601)) / 60)] | 
                    add // 0' workflow_runs.json)

                  MONTHLY_COST=$(echo "$TOTAL_MINUTES * 0.008" | bc)
                  BUDGET_PERCENTAGE=$(echo "scale=2; ($TOTAL_MINUTES / 10000) * 100" | bc)

                  echo "Total minutes (30 days): $TOTAL_MINUTES"
                  echo "Estimated cost: \$$MONTHLY_COST"
                  echo "Budget usage: $BUDGET_PERCENTAGE%"

                  if (( $(echo "$BUDGET_PERCENTAGE > 80" | bc -l) )); then
                    echo "::warning::GitHub Actions usage exceeds 80% of budget"
                  fi

    dependency-updates:
        name: Check Dependencies
        runs-on: ubuntu-latest
        if: inputs.check-type == 'dependencies' || inputs.check-type == 'all' || github.event_name == 'schedule'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Check for outdated packages
              run: |
                  npm outdated --json > outdated.json || true

                  if [ -s outdated.json ]; then
                    echo "Outdated packages found:"
                    jq -r 'to_entries[] | "\(.key): \(.value.current) -> \(.value.wanted)"' outdated.json
                    
                    MAJOR_UPDATES=$(jq 'to_entries | map(select(.value.current != .value.latest)) | length' outdated.json)
                    if [ "$MAJOR_UPDATES" -gt 0 ]; then
                      echo "::warning::$MAJOR_UPDATES packages have major updates available"
                    fi
                  else
                    echo "All packages are up to date"
                  fi

    health-check:
        name: Health Check
        runs-on: ubuntu-latest
        strategy:
            matrix:
                environment: [development, staging, production]
        steps:
            - name: Check application health
              run: |
                  case "${{ matrix.environment }}" in
                    development) URL="https://develop.bayoncoagent.com" ;;
                    staging) URL="https://staging.bayoncoagent.com" ;;
                    production) URL="https://bayoncoagent.com" ;;
                  esac

                  # Basic health check
                  if curl -f -s "$URL" > /dev/null; then
                    echo "‚úÖ ${{ matrix.environment }} is healthy"
                  else
                    echo "‚ùå ${{ matrix.environment }} health check failed"
                    exit 1
                  fi

                  # Check API endpoints
                  if curl -f -s "$URL/api/health" > /dev/null; then
                    echo "‚úÖ ${{ matrix.environment }} API is healthy"
                  else
                    echo "‚ö†Ô∏è ${{ matrix.environment }} API health check failed"
                  fi

    notify-issues:
        name: Notify Issues
        runs-on: ubuntu-latest
        needs:
            [
                security-scan,
                performance-check,
                cost-monitoring,
                dependency-updates,
                health-check,
            ]
        if: always() && (failure() || contains(needs.*.result, 'failure'))
        steps:
            - name: Send alert
              if: env.SLACK_WEBHOOK_URL != ''
              env:
                  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
              run: |
                  FAILED_JOBS=""

                  if [ "${{ needs.security-scan.result }}" = "failure" ]; then
                    FAILED_JOBS="$FAILED_JOBS\n‚Ä¢ Security vulnerabilities detected"
                  fi

                  if [ "${{ needs.performance-check.result }}" = "failure" ]; then
                    FAILED_JOBS="$FAILED_JOBS\n‚Ä¢ Performance issues detected"
                  fi

                  if [ "${{ needs.cost-monitoring.result }}" = "failure" ]; then
                    FAILED_JOBS="$FAILED_JOBS\n‚Ä¢ Cost budget exceeded"
                  fi

                  if [ "${{ needs.health-check.result }}" = "failure" ]; then
                    FAILED_JOBS="$FAILED_JOBS\n‚Ä¢ Application health check failed"
                  fi

                  curl -X POST "$SLACK_WEBHOOK_URL" \
                    -H 'Content-Type: application/json' \
                    -d "{
                      \"text\": \"‚ö†Ô∏è Monitoring Alert\",
                      \"attachments\": [{
                        \"color\": \"warning\",
                        \"fields\": [
                          {
                            \"title\": \"Issues Detected\",
                            \"value\": \"$FAILED_JOBS\",
                            \"short\": false
                          },
                          {
                            \"title\": \"Workflow\",
                            \"value\": \"<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>\",
                            \"short\": true
                          }
                        ]
                      }]
                    }"

    summary:
        name: Monitoring Summary
        runs-on: ubuntu-latest
        needs:
            [
                security-scan,
                performance-check,
                cost-monitoring,
                dependency-updates,
                health-check,
            ]
        if: always()
        steps:
            - name: Generate summary
              run: |
                  echo "## üìä Daily Monitoring Report" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Security Scan | ${{ needs.security-scan.result == 'success' && '‚úÖ Passed' || needs.security-scan.result == 'skipped' && '‚¨ú Skipped' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Performance Check | ${{ needs.performance-check.result == 'success' && '‚úÖ Passed' || needs.performance-check.result == 'skipped' && '‚¨ú Skipped' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Cost Monitoring | ${{ needs.cost-monitoring.result == 'success' && '‚úÖ Passed' || needs.cost-monitoring.result == 'skipped' && '‚¨ú Skipped' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Dependency Updates | ${{ needs.dependency-updates.result == 'success' && '‚úÖ Passed' || needs.dependency-updates.result == 'skipped' && '‚¨ú Skipped' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Health Check | ${{ needs.health-check.result == 'success' && '‚úÖ Passed' || needs.health-check.result == 'skipped' && '‚¨ú Skipped' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
