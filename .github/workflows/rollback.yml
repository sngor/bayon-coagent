name: Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to rollback"
        required: true
        type: choice
        options: [development, staging, production]
      target-version:
        description: "Target version to rollback to (optional)"
        required: false
        type: string
      reason:
        description: "Reason for rollback"
        required: true
        type: string

env:
  AWS_REGION: us-west-2

jobs:
  validate:
    name: Validate Rollback
    runs-on: ubuntu-latest
    outputs:
      stack-name: ${{ steps.config.outputs.stack-name }}
      target-version: ${{ steps.version.outputs.version }}
      requires-approval: ${{ steps.config.outputs.requires-approval }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure environment
        id: config
        run: |
          echo "stack-name=bayon-coagent-${{ inputs.environment }}" >> $GITHUB_OUTPUT
          echo "requires-approval=${{ inputs.environment == 'production' && 'true' || 'false' }}" >> $GITHUB_OUTPUT

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets[format('AWS_ACCESS_KEY_ID_{0}', inputs.environment == 'development' && 'DEV' || inputs.environment == 'staging' && 'STAGING' || 'PROD')] }}
          aws-secret-access-key: ${{ secrets[format('AWS_SECRET_ACCESS_KEY_{0}', inputs.environment == 'development' && 'DEV' || inputs.environment == 'staging' && 'STAGING' || 'PROD')] }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine target version
        id: version
        run: |
          if [ -n "${{ inputs.target-version }}" ]; then
            TARGET_VERSION="${{ inputs.target-version }}"
          else
            # Get previous version from stack tags
            TARGET_VERSION=$(aws cloudformation describe-stacks \
              --stack-name ${{ steps.config.outputs.stack-name }} \
              --query 'Stacks[0].Tags[?Key==`PreviousVersion`].Value' \
              --output text 2>/dev/null || echo "")
            
            if [ -z "$TARGET_VERSION" ]; then
              echo "âŒ Could not determine previous version"
              exit 1
            fi
          fi

          # Verify version exists
          if ! git rev-parse "refs/tags/$TARGET_VERSION" >/dev/null 2>&1; then
            echo "âŒ Target version $TARGET_VERSION does not exist"
            exit 1
          fi

          echo "version=$TARGET_VERSION" >> $GITHUB_OUTPUT

      - name: Check rollback safety
        run: |
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name ${{ steps.config.outputs.stack-name }} \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "DOES_NOT_EXIST")

          case "$STACK_STATUS" in
            UPDATE_COMPLETE|UPDATE_ROLLBACK_COMPLETE|CREATE_COMPLETE)
              echo "âœ… Stack is in a safe state for rollback"
              ;;
            *IN_PROGRESS*)
              echo "âŒ Stack operation in progress. Cannot rollback now."
              exit 1
              ;;
            *)
              echo "âš ï¸ Stack in state: $STACK_STATUS. Proceeding with caution."
              ;;
          esac

  approval:
    name: Rollback Approval
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.requires-approval == 'true'
    environment:
      name: production-rollback
    steps:
      - name: Approval granted
        run: echo "âœ… Rollback approved for ${{ inputs.environment }}"

  rollback-infrastructure:
    name: Rollback Infrastructure
    runs-on: ubuntu-latest
    needs: [validate, approval]
    if: always() && needs.validate.result == 'success' && (needs.approval.result == 'success' || needs.approval.result == 'skipped')
    steps:
      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.target-version }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets[format('AWS_ACCESS_KEY_ID_{0}', inputs.environment == 'development' && 'DEV' || inputs.environment == 'staging' && 'STAGING' || 'PROD')] }}
          aws-secret-access-key: ${{ secrets[format('AWS_SECRET_ACCESS_KEY_{0}', inputs.environment == 'development' && 'DEV' || inputs.environment == 'staging' && 'STAGING' || 'PROD')] }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Rollback CloudFormation stack
        run: |
          STACK_NAME="${{ needs.validate.outputs.stack-name }}"

          CURRENT_STATUS=$(aws cloudformation describe-stacks \
            --stack-name $STACK_NAME \
            --query 'Stacks[0].StackStatus' \
            --output text)

          if [[ "$CURRENT_STATUS" == *"UPDATE"* ]]; then
            aws cloudformation cancel-update-stack \
              --stack-name $STACK_NAME \
              --region ${{ env.AWS_REGION }} || true
            
            aws cloudformation wait stack-rollback-complete \
              --stack-name $STACK_NAME \
              --region ${{ env.AWS_REGION }}
          else
            sam deploy \
              --config-env ${{ inputs.environment }} \
              --no-confirm-changeset \
              --no-fail-on-empty-changeset \
              --region ${{ env.AWS_REGION }}
          fi

  rollback-frontend:
    name: Rollback Frontend
    runs-on: ubuntu-latest
    needs: [validate, rollback-infrastructure]
    steps:
      - name: Checkout target version
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.validate.outputs.target-version }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets[format('AWS_ACCESS_KEY_ID_{0}', inputs.environment == 'development' && 'DEV' || inputs.environment == 'staging' && 'STAGING' || 'PROD')] }}
          aws-secret-access-key: ${{ secrets[format('AWS_SECRET_ACCESS_KEY_{0}', inputs.environment == 'development' && 'DEV' || inputs.environment == 'staging' && 'STAGING' || 'PROD')] }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Rollback Amplify deployment
        run: |
          APP_ID=$(aws amplify list-apps \
            --region ${{ env.AWS_REGION }} \
            --query "apps[?name=='bayon-coagent-${{ inputs.environment }}'].appId" \
            --output text)

          if [ -z "$APP_ID" ]; then
            echo "âŒ Amplify app not found"
            exit 1
          fi

          # Get branch name based on environment
          case "${{ inputs.environment }}" in
            development) BRANCH="develop" ;;
            staging) BRANCH="staging" ;;
            production) BRANCH="main" ;;
          esac

          # Start deployment with target version commit
          aws amplify start-job \
            --app-id $APP_ID \
            --branch-name $BRANCH \
            --job-type RELEASE \
            --commit-id $(git rev-parse ${{ needs.validate.outputs.target-version }}) \
            --region ${{ env.AWS_REGION }}

          # Monitor deployment
          while true; do
            STATUS=$(aws amplify list-jobs \
              --app-id $APP_ID \
              --branch-name $BRANCH \
              --max-results 1 \
              --query 'jobSummaries[0].summary.status' \
              --output text)
            
            if [ "$STATUS" == "SUCCEED" ]; then
              echo "âœ… Frontend rollback completed"
              break
            elif [ "$STATUS" == "FAILED" ] || [ "$STATUS" == "CANCELLED" ]; then
              echo "âŒ Frontend rollback failed: $STATUS"
              exit 1
            fi
            sleep 30
          done

  verify:
    name: Verify Rollback
    runs-on: ubuntu-latest
    needs: [validate, rollback-infrastructure, rollback-frontend]
    steps:
      - name: Run verification tests
        run: |
          echo "Running rollback verification..."

          # Get deployment URL based on environment
          case "${{ inputs.environment }}" in
            development) URL="https://develop.bayoncoagent.com" ;;
            staging) URL="https://staging.bayoncoagent.com" ;;
            production) URL="https://bayoncoagent.com" ;;
          esac

          # Basic health check
          curl -f $URL || exit 1

          echo "âœ… Rollback verification passed"

  notify:
    name: Notify Rollback
    runs-on: ubuntu-latest
    needs: [validate, rollback-infrastructure, rollback-frontend, verify]
    if: always()
    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.rollback-infrastructure.result }}" = "success" ] && [ "${{ needs.rollback-frontend.result }}" = "success" ] && [ "${{ needs.verify.result }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "title=Rollback Completed Successfully" >> $GITHUB_OUTPUT
            echo "message=Rollback to version ${{ needs.validate.outputs.target-version }} completed successfully" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "title=CRITICAL: Rollback Failed" >> $GITHUB_OUTPUT
            echo "message=Rollback failed - immediate attention required" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS_EMOJI="${{ steps.status.outputs.status == 'success' && 'âœ…' || 'ğŸš¨' }}"

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"$STATUS_EMOJI ${{ steps.status.outputs.title }}\",
              \"attachments\": [{
                \"color\": \"${{ steps.status.outputs.status == 'success' && 'good' || 'danger' }}\",
                \"fields\": [
                  {
                    \"title\": \"Environment\",
                    \"value\": \"${{ inputs.environment }}\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Target Version\",
                    \"value\": \"${{ needs.validate.outputs.target-version }}\",
                    \"short\": true
                  },
                  {
                    \"title\": \"Reason\",
                    \"value\": \"${{ inputs.reason }}\",
                    \"short\": false
                  },
                  {
                    \"title\": \"Triggered By\",
                    \"value\": \"${{ github.actor }}\",
                    \"short\": true
                  }
                ]
              }]
            }"

      - name: Create incident report
        if: steps.status.outputs.status == 'failure'
        run: |
          cat > incident-report.md << EOF
          # Rollback Incident Report

          **Environment:** ${{ inputs.environment }}
          **Target Version:** ${{ needs.validate.outputs.target-version }}
          **Reason:** ${{ inputs.reason }}
          **Status:** Failed
          **Triggered By:** ${{ github.actor }}
          **Workflow:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Status
          - Infrastructure Rollback: ${{ needs.rollback-infrastructure.result }}
          - Frontend Rollback: ${{ needs.rollback-frontend.result }}
          - Verification: ${{ needs.verify.result }}

          ## Next Steps
          - [ ] Investigate rollback failure immediately
          - [ ] Check AWS CloudFormation console
          - [ ] Review Amplify deployment logs
          - [ ] Consider manual rollback procedures
          EOF

      - name: Upload incident report
        if: steps.status.outputs.status == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: rollback-incident-report
          path: incident-report.md
          retention-days: 90
