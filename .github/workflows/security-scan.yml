name: Security Scan

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    schedule:
        # Run weekly on Mondays at 9am UTC
        - cron: "0 9 * * 1"

jobs:
    secret-scan:
        name: Scan for secrets
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for better detection

            - name: TruffleHog Secret Scan
              uses: trufflesecurity/trufflehog@main
              with:
                  path: ./
                  base: ${{ github.event.repository.default_branch }}
                  head: HEAD
                  extra_args: --debug --only-verified --exclude-paths .trufflehog-ignore

    dependency-scan:
        name: Scan dependencies
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Run npm audit
              run: npm audit --audit-level=moderate
              continue-on-error: true

            - name: Run Snyk security scan
              uses: snyk/actions/node@master
              continue-on-error: true
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  args: --severity-threshold=high
