name: Security Scan

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main, develop]
    schedule:
        # Run weekly on Mondays at 9am UTC
        - cron: "0 9 * * 1"
    workflow_dispatch:

jobs:
    dependency-scan:
        name: Scan dependencies
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Run npm audit
              id: npm-audit
              run: |
                  echo "Running npm audit with high/critical threshold..."
                  npm audit --audit-level=high --json > npm-audit-results.json || true

                  # Check if there are high or critical vulnerabilities
                  HIGH_VULNS=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-results.json)
                  CRITICAL_VULNS=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-results.json)

                  echo "high_vulnerabilities=$HIGH_VULNS" >> $GITHUB_OUTPUT
                  echo "critical_vulnerabilities=$CRITICAL_VULNS" >> $GITHUB_OUTPUT

                  if [ "$HIGH_VULNS" -gt 0 ] || [ "$CRITICAL_VULNS" -gt 0 ]; then
                    echo "::error::Found $CRITICAL_VULNS critical and $HIGH_VULNS high severity vulnerabilities"
                    npm audit --audit-level=high
                    exit 1
                  fi

                  echo "‚úÖ No high or critical vulnerabilities found"

            - name: Upload npm audit results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: npm-audit-results
                  path: npm-audit-results.json
                  retention-days: 30

            - name: Run Snyk security scan
              uses: snyk/actions/node@master
              env:
                  SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
              with:
                  args: --severity-threshold=high --json-file-output=snyk-results.json

            - name: Upload Snyk results to GitHub Code Scanning
              if: always()
              uses: github/codeql-action/upload-sarif@v3
              with:
                  sarif_file: snyk.sarif
              continue-on-error: true

            - name: Upload Snyk results as artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: snyk-results
                  path: snyk-results.json
                  retention-days: 30

            - name: Create GitHub Security Advisory on findings
              if: failure() && (steps.npm-audit.outputs.critical_vulnerabilities > 0 || steps.npm-audit.outputs.high_vulnerabilities > 0)
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      const auditResults = JSON.parse(fs.readFileSync('npm-audit-results.json', 'utf8'));

                      // Create issue for tracking vulnerabilities
                      const vulnerabilities = auditResults.vulnerabilities || {};
                      const vulnList = Object.entries(vulnerabilities)
                          .filter(([_, v]) => v.severity === 'high' || v.severity === 'critical')
                          .map(([name, v]) => `- **${name}** (${v.severity}): ${v.via[0]?.title || 'No description'}`)
                          .join('\n');

                      if (vulnList) {
                          await github.rest.issues.create({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              title: `üö® Security: High/Critical vulnerabilities detected`,
                              body: `## Security Scan Results\n\n` +
                                    `**Critical vulnerabilities:** ${auditResults.metadata.vulnerabilities.critical || 0}\n` +
                                    `**High vulnerabilities:** ${auditResults.metadata.vulnerabilities.high || 0}\n\n` +
                                    `### Affected Packages\n\n${vulnList}\n\n` +
                                    `**Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n` +
                                    `Please review and address these vulnerabilities as soon as possible.`,
                              labels: ['security', 'dependencies']
                          });
                      }

            - name: Comment on PR with security findings
              if: github.event_name == 'pull_request' && failure()
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      let message = '## üîí Security Scan Results\n\n';

                      try {
                          const auditResults = JSON.parse(fs.readFileSync('npm-audit-results.json', 'utf8'));
                          const critical = auditResults.metadata.vulnerabilities.critical || 0;
                          const high = auditResults.metadata.vulnerabilities.high || 0;
                          
                          if (critical > 0 || high > 0) {
                              message += `‚ö†Ô∏è **Security vulnerabilities detected:**\n\n`;
                              message += `- Critical: ${critical}\n`;
                              message += `- High: ${high}\n\n`;
                              message += `Please review the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.\n`;
                          }
                      } catch (e) {
                          message += `‚ùå Failed to parse security scan results. Check the workflow logs for details.\n`;
                      }

                      await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body: message
                      });

    secrets-scan:
        name: Scan for secrets
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Fetch full history for comprehensive scanning

            - name: TruffleHog OSS
              id: trufflehog
              uses: trufflesecurity/trufflehog@main
              with:
                  path: ./
                  base: ${{ github.event.repository.default_branch }}
                  head: HEAD
                  extra_args: --debug --only-verified

            - name: Scan for AWS credentials
              run: |
                  echo "Scanning for AWS access keys..."
                  if git log --all -p | grep -E "AKIA[0-9A-Z]{16}" > aws-keys.txt; then
                      echo "::error::AWS access keys detected in commit history!"
                      cat aws-keys.txt
                      exit 1
                  fi
                  echo "‚úÖ No AWS access keys found"

            - name: Scan for common secrets patterns
              run: |
                  echo "Scanning for common secret patterns..."

                  # Define patterns to search for
                  PATTERNS=(
                      "password\s*=\s*['\"][^'\"]{8,}"
                      "api[_-]?key\s*=\s*['\"][^'\"]{16,}"
                      "secret[_-]?key\s*=\s*['\"][^'\"]{16,}"
                      "private[_-]?key\s*=\s*['\"]"
                      "token\s*=\s*['\"][^'\"]{16,}"
                      "bearer\s+[a-zA-Z0-9\-._~+/]+=*"
                  )

                  FOUND=0
                  for pattern in "${PATTERNS[@]}"; do
                      if git log --all -p | grep -iE "$pattern" > /dev/null; then
                          echo "::warning::Potential secret pattern detected: $pattern"
                          FOUND=1
                      fi
                  done

                  if [ $FOUND -eq 1 ]; then
                      echo "::error::Potential secrets detected in commit history. Please review manually."
                      exit 1
                  fi

                  echo "‚úÖ No common secret patterns found"

            - name: Notify security team on secret detection
              if: failure()
              uses: actions/github-script@v7
              with:
                  script: |
                      await github.rest.issues.create({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          title: `üö® URGENT: Secrets detected in repository`,
                          body: `## ‚ö†Ô∏è Security Alert: Exposed Credentials Detected\n\n` +
                                `Secrets or credentials have been detected in the repository.\n\n` +
                                `**Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n` +
                                `**Branch:** ${context.ref}\n` +
                                `**Commit:** ${context.sha}\n\n` +
                                `### Immediate Actions Required:\n` +
                                `1. Rotate all potentially exposed credentials immediately\n` +
                                `2. Review the workflow logs to identify the exposed secrets\n` +
                                `3. Remove secrets from git history using git-filter-repo or BFG\n` +
                                `4. Update all affected systems with new credentials\n\n` +
                                `**This is a critical security issue and must be addressed immediately.**`,
                          labels: ['security', 'critical', 'secrets'],
                          assignees: context.payload.sender ? [context.payload.sender.login] : []
                      });

            - name: Block PR on secret detection
              if: failure() && github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body: `## üö® SECRETS DETECTED\n\n` +
                                `This PR contains exposed credentials or secrets and **cannot be merged**.\n\n` +
                                `Please:\n` +
                                `1. Remove all secrets from your code\n` +
                                `2. Use environment variables or GitHub Secrets instead\n` +
                                `3. Rewrite git history to remove the secrets\n` +
                                `4. Force push the cleaned branch\n\n` +
                                `See the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`
                      });

    sast-scan:
        name: Static Application Security Testing (SAST)
        runs-on: ubuntu-latest
        permissions:
            actions: read
            contents: read
            security-events: write

        strategy:
            fail-fast: false
            matrix:
                language: ["javascript", "typescript"]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Initialize CodeQL
              uses: github/codeql-action/init@v3
              with:
                  languages: ${{ matrix.language }}
                  queries: security-extended,security-and-quality
                  config: |
                      paths-ignore:
                          - node_modules
                          - .next
                          - dist
                          - build
                          - coverage

            - name: Autobuild
              uses: github/codeql-action/autobuild@v3

            - name: Perform CodeQL Analysis
              uses: github/codeql-action/analyze@v3
              with:
                  category: "/language:${{matrix.language}}"
                  output: sarif-results
                  upload: true

            - name: Upload SARIF results as artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: codeql-sarif-${{ matrix.language }}
                  path: sarif-results
                  retention-days: 30

            - name: Check for critical findings
              if: always()
              run: |
                  echo "Checking CodeQL results for critical security issues..."
                  # CodeQL will automatically fail the workflow if critical issues are found
                  # This step is for additional logging
                  echo "‚úÖ CodeQL analysis complete. Check Security tab for detailed results."

    license-compliance:
        name: License Compliance Check
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Install license-checker
              run: npm install -g license-checker

            - name: Generate license report
              run: |
                  echo "Generating license report..."
                  license-checker --json --out license-report.json
                  license-checker --summary > license-summary.txt
                  cat license-summary.txt

            - name: Check for problematic licenses
              id: license-check
              run: |
                  echo "Checking for GPL/AGPL licenses..."

                  # Check for problematic licenses
                  PROBLEMATIC_LICENSES=$(license-checker --json | jq -r 'to_entries[] | select(.value.licenses | type == "string" and (contains("GPL") or contains("AGPL"))) | "\(.key): \(.value.licenses)"')

                  if [ -n "$PROBLEMATIC_LICENSES" ]; then
                      echo "::error::Problematic licenses detected!"
                      echo "$PROBLEMATIC_LICENSES"
                      echo "problematic_found=true" >> $GITHUB_OUTPUT
                      echo "problematic_licenses<<EOF" >> $GITHUB_OUTPUT
                      echo "$PROBLEMATIC_LICENSES" >> $GITHUB_OUTPUT
                      echo "EOF" >> $GITHUB_OUTPUT
                      exit 1
                  fi

                  echo "‚úÖ No problematic licenses found"
                  echo "problematic_found=false" >> $GITHUB_OUTPUT

            - name: Upload license report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: license-report
                  path: |
                      license-report.json
                      license-summary.txt
                  retention-days: 30

            - name: Create issue for license violations
              if: failure() && steps.license-check.outputs.problematic_found == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      const problematicLicenses = `${{ steps.license-check.outputs.problematic_licenses }}`;

                      await github.rest.issues.create({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          title: `‚öñÔ∏è License Compliance: Problematic licenses detected`,
                          body: `## License Compliance Issue\n\n` +
                                `The following packages have licenses that may conflict with our licensing requirements:\n\n` +
                                `\`\`\`\n${problematicLicenses}\n\`\`\`\n\n` +
                                `**Workflow run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n` +
                                `### Action Required:\n` +
                                `1. Review the flagged packages and their licenses\n` +
                                `2. Consider alternative packages with compatible licenses\n` +
                                `3. Consult with legal team if necessary\n` +
                                `4. Update dependencies to resolve license conflicts\n\n` +
                                `GPL and AGPL licenses may require open-sourcing derivative works.`,
                          labels: ['legal', 'dependencies', 'license-compliance']
                      });

            - name: Comment on PR with license issues
              if: failure() && github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const problematicLicenses = `${{ steps.license-check.outputs.problematic_licenses }}`;

                      await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body: `## ‚öñÔ∏è License Compliance Issue\n\n` +
                                `This PR introduces dependencies with potentially problematic licenses:\n\n` +
                                `\`\`\`\n${problematicLicenses}\n\`\`\`\n\n` +
                                `Please review these licenses and consider alternatives before merging.\n\n` +
                                `See the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for the full license report.`
                      });
