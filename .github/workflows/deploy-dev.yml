name: Deploy to Development

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip-tests:
        description: "Skip smoke tests (emergency deployments only)"
        required: false
        type: boolean
        default: false

env:
  AWS_REGION: us-west-2
  ENVIRONMENT: development
  STACK_NAME: bayon-coagent-development

jobs:
  # Validate infrastructure before deployment
  validate:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Validate SAM template
        run: sam validate --lint

      - name: Run cfn-lint
        run: |
          pip install cfn-lint
          cfn-lint template.yaml

      - name: Generate change preview
        run: |
          sam deploy \
            --config-env ${{ env.ENVIRONMENT }} \
            --no-execute-changeset \
            --no-fail-on-empty-changeset \
            2>&1 | tee changeset-preview.txt

      - name: Upload changeset preview
        uses: actions/upload-artifact@v4
        with:
          name: changeset-preview
          path: changeset-preview.txt
          retention-days: 7

  # Deploy infrastructure using SAM
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    needs: validate
    outputs:
      stack-outputs: ${{ steps.stack-outputs.outputs.outputs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Deploy SAM stack
        run: |
          sam deploy \
            --config-env ${{ env.ENVIRONMENT }} \
            --parameter-overrides Environment=${{ env.ENVIRONMENT }} \
            --no-fail-on-empty-changeset \
            --no-confirm-changeset

      - name: Wait for stack to stabilize
        run: |
          echo "Waiting for stack to reach stable state..."
          aws cloudformation wait stack-update-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} || \
          aws cloudformation wait stack-create-complete \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }}
          echo "Stack is stable"

      - name: Capture stack outputs
        id: stack-outputs
        run: |
          echo "Retrieving stack outputs..."
          aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs' \
            --output json > stack-outputs.json

          cat stack-outputs.json

          # Convert to single-line JSON for output
          OUTPUTS=$(cat stack-outputs.json | jq -c .)
          echo "outputs=$OUTPUTS" >> $GITHUB_OUTPUT

      - name: Upload stack outputs
        uses: actions/upload-artifact@v4
        with:
          name: stack-outputs
          path: stack-outputs.json
          retention-days: 30

  # Deploy frontend to Amplify
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    outputs:
      deployment-url: ${{ steps.amplify-deploy.outputs.url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download stack outputs
        uses: actions/download-artifact@v4
        with:
          name: stack-outputs

      - name: Extract environment variables from stack outputs
        id: env-vars
        run: |
          # Parse stack outputs and extract key values
          COGNITO_USER_POOL_ID=$(jq -r '.[] | select(.OutputKey=="CognitoUserPoolId") | .OutputValue' stack-outputs.json)
          COGNITO_CLIENT_ID=$(jq -r '.[] | select(.OutputKey=="CognitoClientId") | .OutputValue' stack-outputs.json)
          DYNAMODB_TABLE_NAME=$(jq -r '.[] | select(.OutputKey=="DynamoDBTableName") | .OutputValue' stack-outputs.json)
          S3_BUCKET_NAME=$(jq -r '.[] | select(.OutputKey=="S3BucketName") | .OutputValue' stack-outputs.json)

          echo "cognito_user_pool_id=$COGNITO_USER_POOL_ID" >> $GITHUB_OUTPUT
          echo "cognito_client_id=$COGNITO_CLIENT_ID" >> $GITHUB_OUTPUT
          echo "dynamodb_table_name=$DYNAMODB_TABLE_NAME" >> $GITHUB_OUTPUT
          echo "s3_bucket_name=$S3_BUCKET_NAME" >> $GITHUB_OUTPUT

      - name: Get Amplify App ID
        id: amplify-app
        run: |
          # Find Amplify app by name
          APP_ID=$(aws amplify list-apps \
            --region ${{ env.AWS_REGION }} \
            --query "apps[?name=='bayon-coagent-${{ env.ENVIRONMENT }}'].appId" \
            --output text)

          if [ -z "$APP_ID" ]; then
            echo "‚ùå Amplify app not found. Please run setup script first."
            exit 1
          fi

          echo "app_id=$APP_ID" >> $GITHUB_OUTPUT
          echo "Found Amplify app: $APP_ID"

      - name: Update Amplify environment variables
        run: |
          # Update environment variables in Amplify
          aws amplify update-app \
            --app-id ${{ steps.amplify-app.outputs.app_id }} \
            --region ${{ env.AWS_REGION }} \
            --environment-variables \
              NODE_ENV=${{ env.ENVIRONMENT }} \
              AWS_REGION=${{ env.AWS_REGION }} \
              COGNITO_USER_POOL_ID=${{ steps.env-vars.outputs.cognito_user_pool_id }} \
              COGNITO_CLIENT_ID=${{ steps.env-vars.outputs.cognito_client_id }} \
              DYNAMODB_TABLE_NAME=${{ steps.env-vars.outputs.dynamodb_table_name }} \
              S3_BUCKET_NAME=${{ steps.env-vars.outputs.s3_bucket_name }} \
              BEDROCK_MODEL_ID=anthropic.claude-3-5-sonnet-20241022-v2:0 \
              BEDROCK_REGION=${{ env.AWS_REGION }}

      - name: Trigger Amplify deployment
        id: amplify-deploy
        run: |
          # Start a new deployment
          JOB_ID=$(aws amplify start-job \
            --app-id ${{ steps.amplify-app.outputs.app_id }} \
            --branch-name develop \
            --job-type RELEASE \
            --region ${{ env.AWS_REGION }} \
            --query 'jobSummary.jobId' \
            --output text)

          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "Started Amplify deployment: $JOB_ID"

          # Monitor deployment progress
          echo "Monitoring deployment progress..."
          while true; do
            STATUS=$(aws amplify get-job \
              --app-id ${{ steps.amplify-app.outputs.app_id }} \
              --branch-name develop \
              --job-id $JOB_ID \
              --region ${{ env.AWS_REGION }} \
              --query 'job.summary.status' \
              --output text)
            
            echo "Current status: $STATUS"
            
            if [ "$STATUS" = "SUCCEED" ]; then
              echo "‚úÖ Deployment succeeded"
              break
            elif [ "$STATUS" = "FAILED" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "‚ùå Deployment failed with status: $STATUS"
              exit 1
            fi
            
            sleep 30
          done

          # Get deployment URL
          DEPLOYMENT_URL=$(aws amplify get-app \
            --app-id ${{ steps.amplify-app.outputs.app_id }} \
            --region ${{ env.AWS_REGION }} \
            --query 'app.defaultDomain' \
            --output text)

          FULL_URL="https://develop.${DEPLOYMENT_URL}"
          echo "url=$FULL_URL" >> $GITHUB_OUTPUT
          echo "Deployment URL: $FULL_URL"

  # Run smoke tests
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy-frontend
    if: ${{ !inputs.skip-tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Make smoke test scripts executable
        run: chmod +x scripts/smoke-tests/*.sh

      - name: Run authentication smoke test
        id: test-auth
        run: |
          set +e
          ./scripts/smoke-tests/test-auth.sh "${{ needs.deploy-frontend.outputs.deployment-url }}" > auth-test.log 2>&1
          TEST_RESULT=$?
          cat auth-test.log
          echo "result=$TEST_RESULT" >> $GITHUB_OUTPUT
          exit 0
        continue-on-error: true

      - name: Run database smoke test
        id: test-database
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          set +e
          ./scripts/smoke-tests/test-database.sh "${{ env.ENVIRONMENT }}" > database-test.log 2>&1
          TEST_RESULT=$?
          cat database-test.log
          echo "result=$TEST_RESULT" >> $GITHUB_OUTPUT
          exit 0
        continue-on-error: true

      - name: Run storage smoke test
        id: test-storage
        env:
          ENVIRONMENT: ${{ env.ENVIRONMENT }}
        run: |
          set +e
          ./scripts/smoke-tests/test-storage.sh "${{ env.ENVIRONMENT }}" > storage-test.log 2>&1
          TEST_RESULT=$?
          cat storage-test.log
          echo "result=$TEST_RESULT" >> $GITHUB_OUTPUT
          exit 0
        continue-on-error: true

      - name: Run AI service smoke test
        id: test-ai
        run: |
          set +e
          ./scripts/smoke-tests/test-ai.sh "${{ env.AWS_REGION }}" > ai-test.log 2>&1
          TEST_RESULT=$?
          cat ai-test.log
          echo "result=$TEST_RESULT" >> $GITHUB_OUTPUT
          exit 0
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: smoke-test-results
          path: |
            auth-test.log
            database-test.log
            storage-test.log
            ai-test.log
          retention-days: 30

      - name: Check test results
        run: |
          echo "## Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Authentication | ${{ steps.test-auth.outputs.result == '0' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Database | ${{ steps.test-database.outputs.result == '0' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Storage | ${{ steps.test-storage.outputs.result == '0' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Service | ${{ steps.test-ai.outputs.result == '0' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY

          # Fail if any test failed
          if [ "${{ steps.test-auth.outputs.result }}" != "0" ] || \
             [ "${{ steps.test-database.outputs.result }}" != "0" ] || \
             [ "${{ steps.test-storage.outputs.result }}" != "0" ] || \
             [ "${{ steps.test-ai.outputs.result }}" != "0" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "‚ùå **One or more smoke tests failed. Triggering rollback...**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ **All smoke tests passed!**" >> $GITHUB_STEP_SUMMARY

  # Rollback on failure
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-frontend, smoke-tests]
    if: failure() && needs.deploy-infrastructure.result == 'success'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_DEV }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Rollback CloudFormation stack
        run: |
          echo "Rolling back CloudFormation stack..."

          # Check if stack is in UPDATE_COMPLETE or UPDATE_ROLLBACK_COMPLETE state
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].StackStatus' \
            --output text)

          echo "Current stack status: $STACK_STATUS"

          if [[ "$STACK_STATUS" == *"UPDATE"* ]]; then
            # Initiate rollback
            aws cloudformation cancel-update-stack \
              --stack-name ${{ env.STACK_NAME }} \
              --region ${{ env.AWS_REGION }} || true
            
            # Wait for rollback to complete
            aws cloudformation wait stack-rollback-complete \
              --stack-name ${{ env.STACK_NAME }} \
              --region ${{ env.AWS_REGION }}
            
            echo "‚úÖ Stack rolled back successfully"
          else
            echo "Stack is not in a state that requires rollback"
          fi

      - name: Revert Amplify deployment
        run: |
          echo "Reverting Amplify deployment..."

          # Get Amplify app ID
          APP_ID=$(aws amplify list-apps \
            --region ${{ env.AWS_REGION }} \
            --query "apps[?name=='bayon-coagent-${{ env.ENVIRONMENT }}'].appId" \
            --output text)

          if [ -n "$APP_ID" ]; then
            # Get previous successful job
            PREVIOUS_JOB=$(aws amplify list-jobs \
              --app-id $APP_ID \
              --branch-name develop \
              --region ${{ env.AWS_REGION }} \
              --max-results 10 \
              --query 'jobSummaries[?status==`SUCCEED`] | [0].jobId' \
              --output text)
            
            if [ -n "$PREVIOUS_JOB" ] && [ "$PREVIOUS_JOB" != "None" ]; then
              echo "Redeploying previous successful job: $PREVIOUS_JOB"
              
              # Trigger redeployment of previous job
              aws amplify start-job \
                --app-id $APP_ID \
                --branch-name develop \
                --job-type RETRY \
                --job-id $PREVIOUS_JOB \
                --region ${{ env.AWS_REGION }}
              
              echo "‚úÖ Amplify deployment reverted"
            else
              echo "‚ö†Ô∏è No previous successful deployment found"
            fi
          fi

      - name: Notify rollback
        if: always()
        uses: ./.github/actions/slack-notify
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message-type: urgent
          title: "üö® Development Deployment Rolled Back"
          message: |
            Deployment to development environment failed and has been rolled back.

            *Reason:* Smoke tests failed
            *Branch:* ${{ github.ref_name }}
            *Commit:* ${{ github.sha }}
          environment: ${{ env.ENVIRONMENT }}
          commit-sha: ${{ github.sha }}
          commit-message: ${{ github.event.head_commit.message }}
          author: ${{ github.actor }}
          mention-users: ${{ secrets.SLACK_DEVOPS_USERS }}

  # Send deployment notifications
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [deploy-infrastructure, deploy-frontend, smoke-tests]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Notify deployment started
        if: needs.deploy-infrastructure.result == 'success'
        uses: ./.github/actions/slack-notify
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message-type: info
          title: "üöÄ Development Deployment Started"
          message: |
            Deployment to development environment has started.

            *Branch:* ${{ github.ref_name }}
            *Triggered by:* ${{ github.actor }}
          environment: ${{ env.ENVIRONMENT }}
          commit-sha: ${{ github.sha }}
          commit-message: ${{ github.event.head_commit.message }}
          author: ${{ github.actor }}

      - name: Notify deployment success
        if: needs.smoke-tests.result == 'success'
        uses: ./.github/actions/slack-notify
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message-type: success
          title: "‚úÖ Development Deployment Successful"
          message: |
            Deployment to development environment completed successfully!

            All smoke tests passed.
            *Branch:* ${{ github.ref_name }}
          environment: ${{ env.ENVIRONMENT }}
          deployment-url: ${{ needs.deploy-frontend.outputs.deployment-url }}
          commit-sha: ${{ github.sha }}
          commit-message: ${{ github.event.head_commit.message }}
          author: ${{ github.actor }}

      - name: Notify deployment failure
        if: needs.deploy-infrastructure.result == 'failure' || needs.deploy-frontend.result == 'failure' || needs.smoke-tests.result == 'failure'
        uses: ./.github/actions/slack-notify
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message-type: error
          title: "‚ùå Development Deployment Failed"
          message: |
            Deployment to development environment failed.

            *Failed Stage:* ${{ needs.deploy-infrastructure.result == 'failure' && 'Infrastructure' || needs.deploy-frontend.result == 'failure' && 'Frontend' || 'Smoke Tests' }}
            *Branch:* ${{ github.ref_name }}

            Check the workflow logs for details.
          environment: ${{ env.ENVIRONMENT }}
          commit-sha: ${{ github.sha }}
          commit-message: ${{ github.event.head_commit.message }}
          author: ${{ github.actor }}
          mention-users: ${{ secrets.SLACK_DEVOPS_USERS }}
