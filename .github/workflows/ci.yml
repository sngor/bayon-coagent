name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # Detect changed files to enable conditional execution
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'src/**'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
              - 'next.config.ts'
              - '.github/workflows/**'
            docs:
              - 'docs/**'
              - '*.md'
              - 'README.md'

  quality:
    name: Quality Check (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        node-version: [18, 20, 22]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint
        continue-on-error: true
        id: lint

      - name: Type Check
        run: npm run typecheck
        continue-on-error: true
        id: typecheck

      - name: Format Check
        run: npx prettier --check "src/**/*.{ts,tsx,js,jsx,json,css,md}"
        continue-on-error: true
        id: format

      - name: Report Results
        if: always()
        run: |
          echo "## Quality Check Results (Node ${{ matrix.node-version }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint | ${{ steps.lint.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| TypeScript | ${{ steps.typecheck.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Prettier | ${{ steps.format.outcome == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any check failed
        if: steps.lint.outcome != 'success' || steps.typecheck.outcome != 'success' || steps.format.outcome != 'success'
        run: exit 1

  test:
    name: Unit Tests (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name == 'workflow_dispatch'
    strategy:
      matrix:
        node-version: [18, 20, 22]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run Tests
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        if: matrix.node-version == 20
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage artifacts
        if: matrix.node-version == 20
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: Check coverage threshold
        if: matrix.node-version == 20
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            # Extract coverage percentage using Node.js (more portable than jq)
            COVERAGE=$(node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8')); console.log(data.total.lines.pct);")
            echo "Coverage: $COVERAGE%"
            echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š **Line Coverage: ${COVERAGE}%**" >> $GITHUB_STEP_SUMMARY
            
            # Check if coverage meets threshold (using awk for floating point comparison)
            if awk "BEGIN {exit !($COVERAGE < 70)}"; then
              echo "âŒ Coverage is below 70% threshold" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
            echo "âœ… Coverage meets 70% threshold" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Coverage summary not found, skipping threshold check"
          fi

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name == 'workflow_dispatch'
    services:
      localstack:
        image: localstack/localstack:latest
        env:
          SERVICES: dynamodb,s3,cognito-idp
          DEBUG: 1
          DATA_DIR: /tmp/localstack/data
          DOCKER_HOST: unix:///var/run/docker.sock
        ports:
          - 4566:4566
        options: >-
          --health-cmd "awslocal dynamodb list-tables"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Wait for LocalStack
        run: |
          echo "Waiting for LocalStack to be ready..."
          timeout 60 bash -c 'until curl -s http://localhost:4566/_localstack/health | grep -q "\"dynamodb\": \"available\""; do sleep 2; done'
          echo "LocalStack is ready!"

      - name: Initialize LocalStack resources
        run: npm run localstack:init
        env:
          USE_LOCAL_AWS: true
          AWS_ENDPOINT_URL: http://localhost:4566
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test

      - name: Run integration tests
        run: npm run test -- --testPathPattern=integration
        env:
          USE_LOCAL_AWS: true
          AWS_ENDPOINT_URL: http://localhost:4566
          AWS_REGION: us-east-1
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test

  build:
    name: Build Verification (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: [quality, test]
    strategy:
      matrix:
        node-version: [18, 20, 22]
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Record build start time
        id: build-start
        run: echo "start_time=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Build
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: Calculate build time
        id: build-time
        run: |
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - ${{ steps.build-start.outputs.start_time }}))
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "Build completed in ${BUILD_TIME} seconds"
          echo "## Build Time (Node ${{ matrix.node-version }})" >> $GITHUB_STEP_SUMMARY
          echo "â±ï¸ **${BUILD_TIME} seconds**" >> $GITHUB_STEP_SUMMARY

      - name: Check bundle size
        if: matrix.node-version == 20
        run: |
          # Get build output size
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "Build size: $BUILD_SIZE"
          echo "## Bundle Size" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ **$BUILD_SIZE**" >> $GITHUB_STEP_SUMMARY

      - name: Upload build artifacts
        if: matrix.node-version == 20 && github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next/
          retention-days: 7

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [quality, test, integration-tests, build]
    if: always()
    steps:
      - name: Check job results
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Quality Checks | ${{ needs.quality.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: needs.quality.result != 'success' || needs.test.result != 'success' || needs.integration-tests.result != 'success' || needs.build.result != 'success'
        run: exit 1
