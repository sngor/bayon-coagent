name: Bundle Size Monitoring

on:
    pull_request:
        branches: [main, develop]
    push:
        branches: [main, develop]
    workflow_dispatch:

env:
    NODE_VERSION: "20"

jobs:
    bundle-size:
        name: Check Bundle Size
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build application
              run: npm run build
              env:
                  NODE_ENV: production

            - name: Check bundle sizes
              id: check-size
              run: |
                  npm run bundle:check
              continue-on-error: true

      - name: Generate bundle analysis
        run: npm run analyze
        env:
          NODE_ENV: production

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: .next/analyze/
          retention-days: 30

      - name: Comment PR with bundle size
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read bundle sizes
            const buildDir = path.join(process.cwd(), '.next');
            
            // Create comment body
            let comment = '## ðŸ“¦ Bundle Size Report\n\n';
            comment += 'Bundle size check completed. ';
            comment += 'View the [bundle analysis artifact]';
            comment += `(${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) `;
            comment += 'for detailed breakdown.\n\n';
            comment += '### Thresholds\n';
            comment += '- Initial JS: 200KB\n';
            comment += '- Initial CSS: 50KB\n';
            comment += '- Page JS: 150KB\n\n';
            
            // Post comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if bundle size exceeded
        if: steps.check-size.outcome == 'failure'
        run: exit 1
