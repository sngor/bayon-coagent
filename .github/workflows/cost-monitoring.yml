name: Cost Monitoring

on:
    # Run daily at 2am UTC
    schedule:
        - cron: "0 2 * * *"

    # Allow manual trigger
    workflow_dispatch:
        inputs:
            period:
                description: "Time period to analyze (1d, 7d, 30d)"
                required: false
                default: "30d"
            send_report:
                description: "Send cost report to Slack"
                required: false
                type: boolean
                default: true

# Ensure only one cost monitoring job runs at a time
concurrency:
    group: cost-monitoring
    cancel-in-progress: false

jobs:
    track-usage:
        name: Track GitHub Actions Usage
        runs-on: ubuntu-latest
        outputs:
            total_minutes: ${{ steps.calculate.outputs.total_minutes }}
            budget_percentage: ${{ steps.calculate.outputs.budget_percentage }}
            alert_needed: ${{ steps.calculate.outputs.alert_needed }}
            monthly_cost: ${{ steps.calculate.outputs.monthly_cost }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Get workflow runs for the period
              id: get-runs
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  # Determine the time period
                  PERIOD="${{ github.event.inputs.period || '30d' }}"

                  # Calculate the date based on period
                  if [[ "$PERIOD" == "1d" ]]; then
                    SINCE_DATE=$(date -u -d '1 day ago' +%Y-%m-%dT%H:%M:%SZ)
                  elif [[ "$PERIOD" == "7d" ]]; then
                    SINCE_DATE=$(date -u -d '7 days ago' +%Y-%m-%dT%H:%M:%SZ)
                  else
                    SINCE_DATE=$(date -u -d '30 days ago' +%Y-%m-%dT%H:%M:%SZ)
                  fi

                  echo "period=$PERIOD" >> $GITHUB_OUTPUT
                  echo "since_date=$SINCE_DATE" >> $GITHUB_OUTPUT

                  # Get all workflow runs since the date
                  gh api \
                    -H "Accept: application/vnd.github+json" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    "/repos/${{ github.repository }}/actions/runs?created=>=$SINCE_DATE&per_page=100" \
                    > workflow_runs.json

                  echo "âœ… Retrieved workflow runs since $SINCE_DATE"

            - name: Calculate usage and costs
              id: calculate
              run: |
                  # GitHub Actions pricing (as of 2024)
                  # Free tier: 2000 minutes/month for private repos, unlimited for public
                  # Paid: $0.008 per minute for Linux runners

                  COST_PER_MINUTE=0.008
                  MONTHLY_BUDGET_MINUTES=10000  # Configurable budget
                  MONTHLY_BUDGET_DOLLARS=$(echo "$MONTHLY_BUDGET_MINUTES * $COST_PER_MINUTE" | bc)

                  # Parse workflow runs and calculate total minutes
                  TOTAL_MINUTES=$(jq '[.workflow_runs[] | 
                    select(.conclusion != null) | 
                    (((.updated_at | fromdateiso8601) - (.created_at | fromdateiso8601)) / 60)] | 
                    add // 0' workflow_runs.json)

                  # Round to 2 decimal places
                  TOTAL_MINUTES=$(printf "%.2f" $TOTAL_MINUTES)

                  # Calculate cost
                  MONTHLY_COST=$(echo "$TOTAL_MINUTES * $COST_PER_MINUTE" | bc)
                  MONTHLY_COST=$(printf "%.2f" $MONTHLY_COST)

                  # Calculate budget percentage
                  BUDGET_PERCENTAGE=$(echo "scale=2; ($TOTAL_MINUTES / $MONTHLY_BUDGET_MINUTES) * 100" | bc)
                  BUDGET_PERCENTAGE=$(printf "%.1f" $BUDGET_PERCENTAGE)

                  # Determine if alert is needed (>80% of budget)
                  ALERT_NEEDED="false"
                  if (( $(echo "$BUDGET_PERCENTAGE > 80" | bc -l) )); then
                    ALERT_NEEDED="true"
                  fi

                  echo "total_minutes=$TOTAL_MINUTES" >> $GITHUB_OUTPUT
                  echo "monthly_cost=$MONTHLY_COST" >> $GITHUB_OUTPUT
                  echo "budget_percentage=$BUDGET_PERCENTAGE" >> $GITHUB_OUTPUT
                  echo "alert_needed=$ALERT_NEEDED" >> $GITHUB_OUTPUT
                  echo "monthly_budget_minutes=$MONTHLY_BUDGET_MINUTES" >> $GITHUB_OUTPUT
                  echo "monthly_budget_dollars=$MONTHLY_BUDGET_DOLLARS" >> $GITHUB_OUTPUT

                  echo "ðŸ“Š Usage Summary:"
                  echo "  Total Minutes: $TOTAL_MINUTES"
                  echo "  Estimated Cost: \$$MONTHLY_COST"
                  echo "  Budget Usage: $BUDGET_PERCENTAGE%"
                  echo "  Alert Needed: $ALERT_NEEDED"

            - name: Calculate usage by workflow
              id: by-workflow
              run: |
                  # Calculate minutes per workflow
                  jq -r '.workflow_runs[] | 
                    select(.conclusion != null) | 
                    "\(.name)|\(((.updated_at | fromdateiso8601) - (.created_at | fromdateiso8601)) / 60)"' \
                    workflow_runs.json > workflow_minutes.txt

                  # Aggregate by workflow name
                  awk -F'|' '{sum[$1]+=$2; count[$1]++} 
                    END {for (name in sum) printf "%s|%.2f|%d\n", name, sum[name], count[name]}' \
                    workflow_minutes.txt | sort -t'|' -k2 -rn > workflow_summary.txt

                  echo "ðŸ“‹ Top 5 Workflows by Usage:"
                  head -5 workflow_summary.txt | while IFS='|' read -r name minutes runs; do
                    cost=$(echo "$minutes * 0.008" | bc)
                    cost=$(printf "%.2f" $cost)
                    echo "  - $name: ${minutes}min (\$$cost) across $runs runs"
                  done

            - name: Calculate usage by environment
              id: by-environment
              run: |
                  # Extract environment from workflow names or branches
                  jq -r '.workflow_runs[] | 
                    select(.conclusion != null) | 
                    "\(.head_branch // "unknown")|\(((.updated_at | fromdateiso8601) - (.created_at | fromdateiso8601)) / 60)"' \
                    workflow_runs.json > branch_minutes.txt

                  # Categorize by environment
                  awk -F'|' '
                    /develop|dev/ {dev+=$2; dev_count++}
                    /staging|rc-/ {staging+=$2; staging_count++}
                    /main|production|^v[0-9]/ {prod+=$2; prod_count++}
                    {other+=$2; other_count++}
                    END {
                      printf "development|%.2f|%d\n", dev, dev_count
                      printf "staging|%.2f|%d\n", staging, staging_count
                      printf "production|%.2f|%d\n", prod, prod_count
                      printf "other|%.2f|%d\n", other - dev - staging - prod, other_count - dev_count - staging_count - prod_count
                    }' branch_minutes.txt > environment_summary.txt

                  echo "ðŸŒ Usage by Environment:"
                  cat environment_summary.txt | while IFS='|' read -r env minutes runs; do
                    if (( $(echo "$minutes > 0" | bc -l) )); then
                      cost=$(echo "$minutes * 0.008" | bc)
                      cost=$(printf "%.2f" $cost)
                      echo "  - $env: ${minutes}min (\$$cost) across $runs runs"
                    fi
                  done

            - name: Store usage data
              run: |
                  # Create usage report
                  cat > usage_report.json <<EOF
                  {
                    "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
                    "period": "${{ steps.get-runs.outputs.period }}",
                    "total_minutes": ${{ steps.calculate.outputs.total_minutes }},
                    "monthly_cost": ${{ steps.calculate.outputs.monthly_cost }},
                    "budget_percentage": ${{ steps.calculate.outputs.budget_percentage }},
                    "budget_minutes": ${{ steps.calculate.outputs.monthly_budget_minutes }},
                    "budget_dollars": ${{ steps.calculate.outputs.monthly_budget_dollars }},
                    "alert_needed": ${{ steps.calculate.outputs.alert_needed }}
                  }
                  EOF

                  echo "âœ… Usage report created"

            - name: Upload usage report
              uses: actions/upload-artifact@v4
              with:
                  name: usage-report-${{ github.run_id }}
                  path: |
                      usage_report.json
                      workflow_summary.txt
                      environment_summary.txt
                  retention-days: 90

    alert-on-threshold:
        name: Send Cost Alerts
        runs-on: ubuntu-latest
        needs: track-usage
        if: needs.track-usage.outputs.alert_needed == 'true'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Send Slack alert
              if: env.SLACK_WEBHOOK_URL != ''
              uses: ./.github/actions/slack-notify
              with:
                  webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
                  message-type: warning
                  title: "âš ï¸ GitHub Actions Budget Alert"
                  message: |
                      GitHub Actions usage has exceeded 80% of the monthly budget.

                      **Current Usage:**
                      â€¢ Total Minutes: ${{ needs.track-usage.outputs.total_minutes }}
                      â€¢ Estimated Cost: \$${{ needs.track-usage.outputs.monthly_cost }}
                      â€¢ Budget Usage: ${{ needs.track-usage.outputs.budget_percentage }}%

                      **Action Required:**
                      Review workflow efficiency and consider optimizations to reduce costs.
                  details: |
                      Repository: ${{ github.repository }}
                      Period: Last 30 days
                      Alert Threshold: 80% of budget
                  workflow-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
                  mention-users: ${{ secrets.SLACK_DEVOPS_MENTIONS }}

            - name: Create GitHub issue
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  # Check if an open issue already exists
                  EXISTING_ISSUE=$(gh issue list \
                    --label "cost-alert" \
                    --state open \
                    --json number \
                    --jq '.[0].number')

                  if [ -n "$EXISTING_ISSUE" ]; then
                    echo "âš ï¸ Cost alert issue already exists: #$EXISTING_ISSUE"
                    
                    # Add a comment to the existing issue
                    gh issue comment $EXISTING_ISSUE --body "**Updated Alert - $(date -u +%Y-%m-%d)**

                    GitHub Actions usage continues to exceed budget threshold.
                    
                    **Current Usage:**
                    - Total Minutes: ${{ needs.track-usage.outputs.total_minutes }}
                    - Estimated Cost: \$${{ needs.track-usage.outputs.monthly_cost }}
                    - Budget Usage: ${{ needs.track-usage.outputs.budget_percentage }}%
                    
                    [View detailed report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
                  else
                    echo "ðŸ“ Creating new cost alert issue"
                    
                    gh issue create \
                      --title "âš ï¸ GitHub Actions Budget Alert - $(date -u +%Y-%m-%d)" \
                      --label "cost-alert,devops" \
                      --assignee "${{ github.repository_owner }}" \
                      --body "## GitHub Actions Budget Alert

                    GitHub Actions usage has exceeded 80% of the monthly budget.
                    
                    ### Current Usage
                    - **Total Minutes:** ${{ needs.track-usage.outputs.total_minutes }}
                    - **Estimated Cost:** \$${{ needs.track-usage.outputs.monthly_cost }}
                    - **Budget Usage:** ${{ needs.track-usage.outputs.budget_percentage }}%
                    
                    ### Recommended Actions
                    1. Review workflow efficiency and identify optimization opportunities
                    2. Check for unnecessary workflow runs or redundant jobs
                    3. Consider implementing more aggressive caching strategies
                    4. Review and optimize test execution times
                    5. Evaluate if any workflows can be run less frequently
                    
                    ### Resources
                    - [Detailed Usage Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                    - [GitHub Actions Billing Documentation](https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions)
                    
                    ---
                    *This issue was automatically created by the cost monitoring workflow.*"
                  fi

    generate-report:
        name: Generate Cost Report
        runs-on: ubuntu-latest
        needs: track-usage
        if: github.event.inputs.send_report != 'false'

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Download usage report
              uses: actions/download-artifact@v4
              with:
                  name: usage-report-${{ github.run_id }}

            - name: Generate detailed report
              id: report
              run: |
                  # Read the usage data
                  TOTAL_MINUTES="${{ needs.track-usage.outputs.total_minutes }}"
                  MONTHLY_COST="${{ needs.track-usage.outputs.monthly_cost }}"
                  BUDGET_PCT="${{ needs.track-usage.outputs.budget_percentage }}"

                  # Determine status emoji
                  if (( $(echo "$BUDGET_PCT < 50" | bc -l) )); then
                    STATUS_EMOJI="âœ…"
                    STATUS_TEXT="Healthy"
                  elif (( $(echo "$BUDGET_PCT < 80" | bc -l) )); then
                    STATUS_EMOJI="âš ï¸"
                    STATUS_TEXT="Warning"
                  else
                    STATUS_EMOJI="ðŸš¨"
                    STATUS_TEXT="Critical"
                  fi

                  # Create markdown report
                  cat > cost_report.md <<EOF
                  # GitHub Actions Cost Report

                  **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
                  **Period:** Last 30 days
                  **Status:** $STATUS_EMOJI $STATUS_TEXT

                  ## Summary

                  | Metric | Value |
                  |--------|-------|
                  | Total Minutes | ${TOTAL_MINUTES} |
                  | Estimated Cost | \$${MONTHLY_COST} |
                  | Budget Usage | ${BUDGET_PCT}% |

                  ## Top Workflows by Usage

                  | Workflow | Minutes | Cost | Runs |
                  |----------|---------|------|------|
                  EOF

                  # Add top workflows
                  head -10 workflow_summary.txt | while IFS='|' read -r name minutes runs; do
                    cost=$(echo "$minutes * 0.008" | bc)
                    cost=$(printf "%.2f" $cost)
                    echo "| $name | ${minutes} | \$${cost} | $runs |" >> cost_report.md
                  done

                  cat >> cost_report.md <<EOF

                  ## Usage by Environment

                  | Environment | Minutes | Cost | Runs |
                  |-------------|---------|------|------|
                  EOF

                  # Add environment breakdown
                  cat environment_summary.txt | while IFS='|' read -r env minutes runs; do
                    if (( $(echo "$minutes > 0" | bc -l) )); then
                      cost=$(echo "$minutes * 0.008" | bc)
                      cost=$(printf "%.2f" $cost)
                      echo "| $env | ${minutes} | \$${cost} | $runs |" >> cost_report.md
                    fi
                  done

                  cat >> cost_report.md <<EOF

                  ## Optimization Opportunities

                  EOF

                  # Add optimization suggestions based on usage patterns
                  if (( $(echo "$BUDGET_PCT > 80" | bc -l) )); then
                    cat >> cost_report.md <<EOF
                  ### High Priority
                  - âš ï¸ **Budget threshold exceeded** - Immediate action required
                  - Review and optimize the top 3 workflows listed above
                  - Consider implementing more aggressive caching strategies
                  - Evaluate test suite execution times and parallelize where possible

                  EOF
                  fi

                  cat >> cost_report.md <<EOF
                  ### General Recommendations
                  - Implement dependency caching to reduce build times
                  - Use conditional job execution to skip unnecessary runs
                  - Optimize test suites to run only affected tests
                  - Consider using self-hosted runners for high-volume workflows
                  - Review scheduled workflows and adjust frequency if needed

                  ---
                  *For more details, see the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
                  EOF

                  echo "âœ… Cost report generated"

            - name: Upload cost report
              uses: actions/upload-artifact@v4
              with:
                  name: cost-report-${{ github.run_id }}
                  path: cost_report.md
                  retention-days: 90

            - name: Send report to Slack
              if: env.SLACK_WEBHOOK_URL != ''
              uses: ./.github/actions/slack-notify
              with:
                  webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
                  message-type: info
                  title: "ðŸ“Š GitHub Actions Cost Report"
                  message: |
                      Monthly cost report for GitHub Actions usage.

                      **Summary:**
                      â€¢ Total Minutes: ${{ needs.track-usage.outputs.total_minutes }}
                      â€¢ Estimated Cost: \$${{ needs.track-usage.outputs.monthly_cost }}
                      â€¢ Budget Usage: ${{ needs.track-usage.outputs.budget_percentage }}%
                  details: |
                      Period: Last 30 days
                      Status: ${{ steps.report.outputs.status_text || 'Healthy' }}
                  workflow-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            - name: Summary
              run: |
                  echo "## ðŸ“Š Cost Monitoring Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  cat cost_report.md >> $GITHUB_STEP_SUMMARY
