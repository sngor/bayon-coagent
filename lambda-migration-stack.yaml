AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: API Gateway + Lambda Migration Stack

Parameters:
  Environment:
    Type: String
    Default: development

  DynamoDBTableName:
    Type: String
    Description: Name of the existing DynamoDB table
    Default: BayonCoAgent-development

  S3BucketName:
    Type: String
    Description: Name of the existing S3 bucket
    Default: bayon-coagent-storage-development-409136660268

  ApplicationRoleArn:
    Type: String
    Description: ARN of the existing application role
    Default: arn:aws:iam::409136660268:role/bayon-coagent-app-development

Resources:
  # AI Content Generation Lambda
  AiContentGenerationFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-ai-content-generation-${Environment}
      CodeUri: infrastructure/lambda-functions/ai-content-generation/
      Handler: index.handler
      Runtime: nodejs22.x
      Timeout: 300
      MemorySize: 2048
      Role: !Ref ApplicationRoleArn
      Environment:
        Variables:
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTableName
          S3_BUCKET_NAME: !Ref S3BucketName
          BEDROCK_MODEL_ID: anthropic.claude-3-5-sonnet-20241022-v2:0
          BEDROCK_REGION: !Ref AWS::Region
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AIService
        Function: ContentGeneration

  # AI Research Lambda
  AiResearchFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub bayon-coagent-ai-research-${Environment}
      CodeUri: infrastructure/lambda-functions/ai-research/
      Handler: index.handler
      Runtime: nodejs22.x
      Timeout: 300
      MemorySize: 2048
      Role: !Ref ApplicationRoleArn
      Environment:
        Variables:
          DYNAMODB_TABLE_NAME: !Ref DynamoDBTableName
          S3_BUCKET_NAME: !Ref S3BucketName
          BEDROCK_MODEL_ID: anthropic.claude-3-5-sonnet-20241022-v2:0
          BEDROCK_REGION: !Ref AWS::Region
      Tags:
        Environment: !Ref Environment
        Application: BayonCoAgent
        Service: AIService
        Function: Research

Outputs:
  AiContentGenerationFunctionArn:
    Description: AI Content Generation Lambda Function ARN
    Value: !GetAtt AiContentGenerationFunction.Arn
    Export:
      Name: !Sub ${Environment}-AiContentGenerationFunctionArn

  AiContentGenerationFunctionName:
    Description: AI Content Generation Lambda Function Name
    Value: !Ref AiContentGenerationFunction
    Export:
      Name: !Sub ${Environment}-AiContentGenerationFunctionName

  AiResearchFunctionArn:
    Description: AI Research Lambda Function ARN
    Value: !GetAtt AiResearchFunction.Arn
    Export:
      Name: !Sub ${Environment}-AiResearchFunctionArn

  AiResearchFunctionName:
    Description: AI Research Lambda Function Name
    Value: !Ref AiResearchFunction
    Export:
      Name: !Sub ${Environment}-AiResearchFunctionName
