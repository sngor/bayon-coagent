version: 1
# AWS Amplify Build Specification for Bayon CoAgent Next.js Application
# This file configures the build process for AWS Amplify Hosting

# Environment variables are configured in the Amplify Console
# Required environment variables:
# - NODE_ENV=production
# - AWS_REGION
# - COGNITO_USER_POOL_ID
# - COGNITO_CLIENT_ID
# - DYNAMODB_TABLE_NAME
# - S3_BUCKET_NAME
# - BEDROCK_MODEL_ID
# - BEDROCK_REGION
# - GOOGLE_CLIENT_ID
# - GOOGLE_CLIENT_SECRET
# - GOOGLE_REDIRECT_URI
# - BRIDGE_API_KEY
# - NEWS_API_KEY
#
# Sensitive API keys (stored in Amplify Secrets and parameters):
# OAuth Secrets:
# - GOOGLE_CLIENT_SECRET
# - FACEBOOK_APP_SECRET
# - LINKEDIN_CLIENT_SECRET
# External API Keys:
# - GOOGLE_AI_API_KEY
# - BRIDGE_API_KEY
# - TAVILY_API_KEY
# - SERPER_API_KEY (if using)
# MLS Provider Secrets:
# - FLEXMLS_CLIENT_SECRET
# - CRMLS_CLIENT_SECRET
# - BRIGHT_CLIENT_SECRET
# - MLSGRID_CLIENT_SECRET
# Payment Processing:
# - STRIPE_SECRET_KEY
# - STRIPE_WEBHOOK_SECRET

frontend:
  phases:
    preBuild:
      commands:
        - echo "Node.js version:"
        - node --version
        - echo "NPM version:"
        - npm --version
        - echo "Available memory:"
        - free -h || echo "Memory info not available"
        - echo "Setting Node.js options for memory..."
        - export NODE_OPTIONS="--max-old-space-size=8192 --max-semi-space-size=512"
        - echo "Cleaning npm cache..."
        - npm cache clean --force
        - echo "Removing any existing node_modules..."
        - rm -rf node_modules
        - echo "Installing dependencies with memory optimizations..."
        - npm ci --prefer-offline --no-audit --progress=false --loglevel=error --maxsockets=1
        - echo "Dependencies installed successfully"

    build:
      commands:
        - echo "Building Next.js application..."
        - echo "NODE_ENV=$NODE_ENV"
        - export NODE_OPTIONS="--max-old-space-size=8192 --max-semi-space-size=512"
        - echo "Disabling source maps for production build..."
        - export GENERATE_SOURCEMAP=false
        - echo "Starting build process with memory optimizations..."
        - npm run build
        - echo "Build completed successfully"

  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
    secondaryArtifacts:
      - baseDirectory: public
        files:
          - "**/*"
      - baseDirectory: .
        files:
          - package.json
          - package-lock.json
          - next.config.ts

  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*

# Custom headers for security and performance
customHeaders:
  - pattern: "**/*"
    headers:
      - key: "Strict-Transport-Security"
        value: "max-age=31536000; includeSubDomains"
      - key: "X-Frame-Options"
        value: "DENY"
      - key: "X-Content-Type-Options"
        value: "nosniff"
      - key: "X-XSS-Protection"
        value: "1; mode=block"
      - key: "Referrer-Policy"
        value: "strict-origin-when-cross-origin"

  - pattern: "*.js"
    headers:
      - key: "Cache-Control"
        value: "public, max-age=31536000, immutable"

  - pattern: "*.css"
    headers:
      - key: "Cache-Control"
        value: "public, max-age=31536000, immutable"

  - pattern: "*.jpg"
    headers:
      - key: "Cache-Control"
        value: "public, max-age=31536000, immutable"

  - pattern: "*.png"
    headers:
      - key: "Cache-Control"
        value: "public, max-age=31536000, immutable"

  - pattern: "*.svg"
    headers:
      - key: "Cache-Control"
        value: "public, max-age=31536000, immutable"
